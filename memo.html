<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" sizes="32x32" href="./images/icon.png?v=3">
<title>Todo & Memo</title>

<!-- External Libraries -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  background: #0a0a0a;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
  background-attachment: fixed;
  color: #fff;
  min-height: 100vh;
}

header {
  background: rgba(0, 0, 0, 0.9);
  border-bottom: 2px solid rgba(103, 6, 118, 0.4);
  padding: 1.5rem 2rem;
  backdrop-filter: blur(10px);
  position: sticky;
  top: 0;
  z-index: 100;
}

nav {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
}

.logo {
  font-size: 1.75rem;
  font-weight: bold;
  background: linear-gradient(135deg, #a855f7, #ec4899);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.header-actions {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.header-btn {
  background: rgba(103, 6, 118, 0.2);
  border: 1px solid rgba(103, 6, 118, 0.3);
  color: #a855f7;
  padding: 0.6rem 1.2rem;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  font-size: 0.9rem;
}

.header-btn:hover {
  background: rgba(103, 6, 118, 0.4);
  border-color: #670676;
  transform: translateY(-2px);
}

main {
  padding: 3rem 1.5rem;
}

.mode-switcher {
  max-width: 1200px;
  margin: 0 auto 2rem;
  display: flex;
  gap: 1rem;
  justify-content: center;
  flex-wrap: wrap;
}

.mode-btn {
  background: rgba(103, 6, 118, 0.2);
  border: 2px solid rgba(103, 6, 118, 0.3);
  border-radius: 12px;
  padding: 1rem 2rem;
  color: #9ca3af;
  font-size: 1.1rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
}

.mode-btn:hover {
  border-color: #670676;
  transform: translateY(-2px);
}

.mode-btn.active {
  background: linear-gradient(135deg, #670676, #8800aa);
  border-color: #670676;
  color: #fff;
  box-shadow: 0 8px 20px rgba(103, 6, 118, 0.4);
}

.content-area {
  max-width: 1200px;
  margin: 0 auto;
}

.todo-container, .memo-container {
  background: linear-gradient(135deg, rgba(17, 17, 17, 0.95), rgba(0, 0, 0, 0.95));
  border: 2px solid rgba(103, 6, 118, 0.3);
  border-radius: 16px;
  padding: 2.5rem;
  display: none;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
}

.todo-container.active, .memo-container.active {
  display: block;
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

h1 {
  font-size: 2.5rem;
  margin-bottom: 2rem;
  text-align: center;
  background: linear-gradient(135deg, #a855f7, #ec4899);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.input-section {
  display: flex;
  gap: 0.75rem;
  margin-bottom: 2rem;
  flex-wrap: wrap;
}

#todoInput, #memoTitle, #memoContent, #memoTags {
  width: 100%;
  background: rgba(103, 6, 118, 0.1);
  border: 2px solid rgba(103, 6, 118, 0.3);
  border-radius: 8px;
  padding: 0.875rem 1.25rem;
  color: #fff;
  font-size: 1rem;
  transition: all 0.3s;
}

#memoContent {
  min-height: 200px;
  resize: vertical;
  font-family: 'Monaco', 'Courier New', monospace;
  line-height: 1.6;
}

input:focus, textarea:focus {
  outline: none;
  border-color: #670676;
  box-shadow: 0 0 20px rgba(103, 6, 118, 0.3);
}

input::placeholder, textarea::placeholder {
  color: #6b7280;
}

.btn-primary {
  background: linear-gradient(135deg, #670676, #8800aa);
  border: none;
  border-radius: 8px;
  padding: 0.875rem 2rem;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(103, 6, 118, 0.3);
}

.btn-primary:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 20px rgba(103, 6, 118, 0.5);
}

.btn-success {
  background: linear-gradient(135deg, #10b981, #059669);
  border: none;
  border-radius: 8px;
  padding: 0.875rem 2rem;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-success:hover {
  transform: scale(1.05);
}

.filter-tabs, .memo-filters {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}

.filter-btn {
  background: transparent;
  border: 1px solid rgba(103, 6, 118, 0.3);
  color: #9ca3af;
  padding: 0.5rem 1rem;
  cursor: pointer;
  font-weight: 600;
  border-radius: 6px;
  transition: all 0.3s;
}

.filter-btn:hover {
  border-color: #670676;
}

.filter-btn.active {
  background: rgba(103, 6, 118, 0.3);
  color: #a855f7;
  border-color: #670676;
}

.todo-list {
  list-style: none;
  max-height: 500px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: #670676 rgba(103, 6, 118, 0.2);
}

.todo-list::-webkit-scrollbar {
  width: 8px;
}

.todo-list::-webkit-scrollbar-track {
  background: rgba(103, 6, 118, 0.2);
  border-radius: 10px;
}

.todo-list::-webkit-scrollbar-thumb {
  background: #670676;
  border-radius: 10px;
}

.todo-item {
  background: rgba(103, 6, 118, 0.1);
  border: 1px solid rgba(103, 6, 118, 0.2);
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 0.75rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  transition: all 0.3s;
}

.todo-item:hover {
  border-color: #670676;
  transform: translateX(4px);
}

.todo-main-row {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.checkbox {
  width: 24px;
  height: 24px;
  min-width: 24px;
  border: 2px solid #670676;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
}

.checkbox:hover {
  background: rgba(103, 6, 118, 0.2);
}

.checkbox.checked {
  background: #670676;
}

.checkbox.checked::after {
  content: '‚úì';
  color: #fff;
  font-weight: bold;
}

.todo-text {
  flex: 1;
  font-size: 1rem;
  word-break: break-word;
}

.todo-item.completed .todo-text {
  text-decoration: line-through;
  color: #6b7280;
}

.todo-actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.priority-badge {
  padding: 0.25rem 0.6rem;
  border-radius: 4px;
  font-size: 0.7rem;
  font-weight: bold;
  white-space: nowrap;
}

.priority-high {
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
  border: 1px solid rgba(239, 68, 68, 0.3);
}

.priority-medium {
  background: rgba(251, 191, 36, 0.2);
  color: #fbbf24;
  border: 1px solid rgba(251, 191, 36, 0.3);
}

.priority-low {
  background: rgba(16, 185, 129, 0.2);
  color: #10b981;
  border: 1px solid rgba(16, 185, 129, 0.3);
}

.due-date-badge {
  padding: 0.25rem 0.6rem;
  border-radius: 4px;
  font-size: 0.7rem;
  font-weight: bold;
  background: rgba(59, 130, 246, 0.2);
  color: #3b82f6;
  border: 1px solid rgba(59, 130, 246, 0.3);
  white-space: nowrap;
}

.due-date-badge.overdue {
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
  border-color: rgba(239, 68, 68, 0.3);
}

.todo-meta {
  display: flex;
  gap: 1rem;
  font-size: 0.8rem;
  color: #9ca3af;
  padding-left: 2.5rem;
  flex-wrap: wrap;
}

.todo-tag {
  background: rgba(103, 6, 118, 0.2);
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  border: 1px solid rgba(103, 6, 118, 0.3);
}

.action-btn {
  background: rgba(220, 38, 38, 0.2);
  border: 1px solid rgba(220, 38, 38, 0.3);
  border-radius: 6px;
  padding: 0.4rem 0.7rem;
  color: #ef4444;
  cursor: pointer;
  font-size: 0.75rem;
  transition: all 0.3s;
  white-space: nowrap;
}

.action-btn:hover {
  background: rgba(220, 38, 38, 0.3);
  transform: scale(1.05);
}

.action-btn.export {
  background: rgba(16, 185, 129, 0.2);
  border-color: rgba(16, 185, 129, 0.3);
  color: #10b981;
}

.action-btn.export:hover {
  background: rgba(16, 185, 129, 0.3);
}

.action-btn.edit {
  background: rgba(59, 130, 246, 0.2);
  border-color: rgba(59, 130, 246, 0.3);
  color: #3b82f6;
}

.action-btn.edit:hover {
  background: rgba(59, 130, 246, 0.3);
}

.action-btn.duplicate {
  background: rgba(168, 85, 247, 0.2);
  border-color: rgba(168, 85, 247, 0.3);
  color: #a855f7;
}

.action-btn.duplicate:hover {
  background: rgba(168, 85, 247, 0.3);
}

.export-section {
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid rgba(103, 6, 118, 0.3);
  display: flex;
  gap: 1rem;
  justify-content: center;
  flex-wrap: wrap;
}

.stats {
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid rgba(103, 6, 118, 0.3);
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1.5rem;
  text-align: center;
}

.stat-item {
  background: rgba(103, 6, 118, 0.1);
  border: 1px solid rgba(103, 6, 118, 0.2);
  border-radius: 12px;
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  transition: all 0.3s;
}

.stat-item:hover {
  border-color: #670676;
  transform: translateY(-4px);
}

.stat-value {
  font-size: 2rem;
  font-weight: bold;
  background: linear-gradient(135deg, #a855f7, #ec4899);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.stat-label {
  font-size: 0.875rem;
  color: #9ca3af;
}

.memo-toolbar {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  flex-wrap: wrap;
}

.toolbar-btn {
  background: rgba(103, 6, 118, 0.2);
  border: 1px solid rgba(103, 6, 118, 0.3);
  color: #a855f7;
  padding: 0.5rem 0.75rem;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  font-size: 0.85rem;
  white-space: nowrap;
}

.toolbar-btn:hover {
  background: rgba(103, 6, 118, 0.4);
  border-color: #670676;
  transform: translateY(-2px);
}

.memo-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1rem;
  max-height: 600px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: #670676 rgba(103, 6, 118, 0.2);
}

.memo-list::-webkit-scrollbar {
  width: 8px;
}

.memo-list::-webkit-scrollbar-track {
  background: rgba(103, 6, 118, 0.2);
  border-radius: 10px;
}

.memo-list::-webkit-scrollbar-thumb {
  background: #670676;
  border-radius: 10px;
}

.memo-item {
  background: rgba(103, 6, 118, 0.15);
  border: 1px solid rgba(103, 6, 118, 0.3);
  border-radius: 12px;
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  transition: all 0.3s;
}

.memo-item:hover {
  border-color: #670676;
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(103, 6, 118, 0.3);
}

.memo-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 1rem;
}

.memo-title {
  font-size: 1.25rem;
  font-weight: bold;
  color: #a855f7;
  flex: 1;
  word-break: break-word;
}

.memo-actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.memo-content {
  color: #d1d5db;
  line-height: 1.6;
  white-space: pre-wrap;
  word-break: break-word;
}

.memo-preview {
  background: rgba(103, 6, 118, 0.05);
  border: 2px solid rgba(103, 6, 118, 0.3);
  border-radius: 8px;
  padding: 1.5rem;
  margin-bottom: 1rem;
  min-height: 200px;
  max-height: 400px;
  overflow-y: auto;
  display: none;
}

.memo-preview.active {
  display: block;
}

.memo-preview h1, .memo-preview h2, .memo-preview h3 {
  color: #a855f7;
  margin-top: 1rem;
  margin-bottom: 0.5rem;
}

.memo-preview h1 { font-size: 2rem; }
.memo-preview h2 { font-size: 1.5rem; }
.memo-preview h3 { font-size: 1.25rem; }

.memo-preview p {
  margin-bottom: 1rem;
}

.memo-preview code {
  background: rgba(103, 6, 118, 0.3);
  padding: 0.2rem 0.4rem;
  border-radius: 4px;
  color: #ec4899;
  font-family: 'Courier New', monospace;
}

.memo-preview pre {
  background: rgba(0, 0, 0, 0.5);
  padding: 1rem;
  border-radius: 8px;
  overflow-x: auto;
  border: 1px solid rgba(103, 6, 118, 0.3);
  margin: 1rem 0;
}

.memo-preview pre code {
  background: none;
  padding: 0;
  color: #a855f7;
}

.memo-preview blockquote {
  border-left: 4px solid #670676;
  padding-left: 1rem;
  margin: 1rem 0;
  color: #9ca3af;
  font-style: italic;
}

.memo-preview ul, .memo-preview ol {
  margin-left: 1.5rem;
  margin-bottom: 1rem;
}

.memo-preview li {
  margin-bottom: 0.5rem;
}

.memo-preview table {
  width: 100%;
  border-collapse: collapse;
  margin: 1rem 0;
}

.memo-preview table th, .memo-preview table td {
  border: 1px solid rgba(103, 6, 118, 0.3);
  padding: 0.75rem;
  text-align: left;
}

.memo-preview table th {
  background: rgba(103, 6, 118, 0.2);
  color: #a855f7;
  font-weight: bold;
}

.memo-preview img {
  max-width: 100%;
  border-radius: 8px;
  margin: 1rem 0;
}

.memo-preview a {
  color: #3b82f6;
  text-decoration: underline;
}

.memo-preview a:hover {
  color: #60a5fa;
}

.memo-preview hr {
  border: none;
  border-top: 2px solid rgba(103, 6, 118, 0.3);
  margin: 1.5rem 0;
}

.view-toggle {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.view-btn {
  background: rgba(103, 6, 118, 0.2);
  border: 1px solid rgba(103, 6, 118, 0.3);
  color: #a855f7;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  font-size: 0.9rem;
}

.view-btn:hover {
  background: rgba(103, 6, 118, 0.4);
  border-color: #670676;
}

.view-btn.active {
  background: rgba(103, 6, 118, 0.4);
  border-color: #670676;
  box-shadow: 0 4px 10px rgba(103, 6, 118, 0.3);
}

.chart-container {
  background: rgba(103, 6, 118, 0.1);
  border: 1px solid rgba(103, 6, 118, 0.2);
  border-radius: 12px;
  padding: 1.5rem;
  margin: 1rem 0;
}

.memo-tags-display {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.memo-tag-item {
  background: rgba(103, 6, 118, 0.3);
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  color: #a855f7;
  border: 1px solid rgba(103, 6, 118, 0.4);
}

.memo-date {
  font-size: 0.75rem;
  color: #6b7280;
  text-align: right;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 2rem;
  backdrop-filter: blur(5px);
}

.modal.active {
  display: flex;
  animation: fadeIn 0.3s ease-in-out;
}

.modal-content {
  background: linear-gradient(135deg, rgba(17, 17, 17, 0.98), rgba(0, 0, 0, 0.98));
  border: 2px solid #670676;
  border-radius: 16px;
  padding: 2rem;
  max-width: 600px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
  box-shadow: 0 20px 60px rgba(103, 6, 118, 0.5);
}

.modal-title {
  font-size: 1.5rem;
  margin-bottom: 1.5rem;
  color: #a855f7;
}

.modal-input, .modal-select, .modal-textarea {
  width: 100%;
  background: rgba(103, 6, 118, 0.1);
  border: 2px solid rgba(103, 6, 118, 0.3);
  border-radius: 8px;
  padding: 0.875rem;
  color: #fff;
  margin-bottom: 1rem;
  transition: all 0.3s;
}

.modal-textarea {
  min-height: 100px;
  resize: vertical;
  font-family: inherit;
}

.modal-input:focus, .modal-select:focus, .modal-textarea:focus {
  outline: none;
  border-color: #670676;
  box-shadow: 0 0 20px rgba(103, 6, 118, 0.3);
}

.modal-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
  flex-wrap: wrap;
}

.modal-btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
}

.modal-btn-primary {
  background: linear-gradient(135deg, #670676, #8800aa);
  color: #fff;
}

.modal-btn-primary:hover {
  transform: scale(1.05);
}

.modal-btn-secondary {
  background: rgba(103, 6, 118, 0.2);
  color: #a855f7;
  border: 1px solid rgba(103, 6, 118, 0.3);
}

.modal-btn-secondary:hover {
  background: rgba(103, 6, 118, 0.4);
}

.close-modal {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: rgba(220, 38, 38, 0.2);
  border: none;
  color: #ef4444;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s;
}

.close-modal:hover {
  background: rgba(220, 38, 38, 0.4);
}

.confirm-dialog {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  z-index: 2000;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(5px);
}

.confirm-dialog.active {
  display: flex;
  animation: fadeIn 0.2s ease-in-out;
}

.confirm-dialog-content {
  background: linear-gradient(135deg, rgba(17, 17, 17, 0.98), rgba(0, 0, 0, 0.98));
  border: 2px solid #670676;
  border-radius: 16px;
  padding: 2rem;
  max-width: 450px;
  width: 90%;
  box-shadow: 0 20px 60px rgba(103, 6, 118, 0.5);
}

.confirm-dialog-title {
  font-size: 1.25rem;
  margin-bottom: 1rem;
  color: #a855f7;
  font-weight: bold;
}

.confirm-dialog-message {
  color: #d1d5db;
  margin-bottom: 1.5rem;
  line-height: 1.6;
}

.confirm-dialog-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
}

.confirm-btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
}

.confirm-btn-danger {
  background: linear-gradient(135deg, #dc2626, #991b1b);
  color: #fff;
}

.confirm-btn-danger:hover {
  transform: scale(1.05);
}

.confirm-btn-cancel {
  background: rgba(103, 6, 118, 0.2);
  color: #a855f7;
  border: 1px solid rgba(103, 6, 118, 0.3);
}

.confirm-btn-cancel:hover {
  background: rgba(103, 6, 118, 0.4);
}

.shortcuts-list {
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

.shortcut-section h3 {
  color: #a855f7;
  font-size: 1.1rem;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid rgba(103, 6, 118, 0.3);
}

.shortcut-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem;
  background: rgba(103, 6, 118, 0.1);
  border-radius: 8px;
  margin-bottom: 0.5rem;
}

.shortcut-item kbd {
  background: rgba(103, 6, 118, 0.3);
  border: 1px solid rgba(103, 6, 118, 0.5);
  border-radius: 4px;
  padding: 0.25rem 0.5rem;
  font-family: 'Courier New', monospace;
  font-size: 0.85rem;
  color: #a855f7;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.shortcut-item span {
  color: #d1d5db;
}

.search-results {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-top: 1rem;
}

.search-result-item {
  background: rgba(103, 6, 118, 0.1);
  border: 1px solid rgba(103, 6, 118, 0.3);
  border-radius: 8px;
  padding: 1rem;
  cursor: pointer;
  transition: all 0.3s;
}

.search-result-item:hover {
  border-color: #670676;
  transform: translateX(4px);
}

.search-result-title {
  font-weight: bold;
  color: #a855f7;
  margin-bottom: 0.5rem;
}

.search-result-preview {
  color: #9ca3af;
  font-size: 0.9rem;
}

.sort-controls {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
  align-items: center;
}

.sort-label {
  color: #9ca3af;
  font-size: 0.9rem;
  font-weight: 600;
}

.sort-select {
  background: rgba(103, 6, 118, 0.2);
  border: 1px solid rgba(103, 6, 118, 0.3);
  color: #a855f7;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
}

.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  color: #6b7280;
}

.empty-state-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.empty-state-text {
  font-size: 1.2rem;
}

@media (max-width: 768px) {
  .mode-switcher, .input-section, .export-section {
    flex-direction: column;
  }
  
  .memo-list {
    grid-template-columns: 1fr;
  }
  
  .stats {
    grid-template-columns: 1fr;
  }
  
  h1 {
    font-size: 2rem;
  }
  
  .todo-main-row {
    flex-wrap: wrap;
  }
  
  .todo-actions {
    width: 100%;
    padding-left: 2.5rem;
  }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.todo-item, .memo-item {
  animation: slideIn 0.3s ease-out;
}

.login-screen {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: 2rem;
}

.login-container {
  background: linear-gradient(135deg, rgba(17, 17, 17, 0.95), rgba(0, 0, 0, 0.95));
  border: 2px solid rgba(103, 6, 118, 0.3);
  border-radius: 16px;
  padding: 3rem;
  max-width: 450px;
  width: 100%;
  box-shadow: 0 20px 60px rgba(103, 6, 118, 0.4);
}

.login-logo {
  text-align: center;
  font-size: 3rem;
  margin-bottom: 1rem;
}

.login-title {
  text-align: center;
  font-size: 2rem;
  margin-bottom: 2rem;
  background: linear-gradient(135deg, #a855f7, #ec4899);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.login-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 2rem;
}

.login-tab {
  flex: 1;
  background: rgba(103, 6, 118, 0.2);
  border: 1px solid rgba(103, 6, 118, 0.3);
  color: #9ca3af;
  padding: 0.75rem;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 600;
  text-align: center;
}

.login-tab:hover {
  border-color: #670676;
}

.login-tab.active {
  background: rgba(103, 6, 118, 0.4);
  border-color: #670676;
  color: #a855f7;
}

.login-form, .register-form {
  display: none;
}

.login-form.active, .register-form.active {
  display: block;
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-label {
  display: block;
  margin-bottom: 0.5rem;
  color: #9ca3af;
  font-weight: 600;
}

.form-input {
  width: 100%;
  background: rgba(103, 6, 118, 0.1);
  border: 2px solid rgba(103, 6, 118, 0.3);
  border-radius: 8px;
  padding: 0.875rem 1.25rem;
  color: #fff;
  font-size: 1rem;
  transition: all 0.3s;
}

.form-input:focus {
  outline: none;
  border-color: #670676;
  box-shadow: 0 0 20px rgba(103, 6, 118, 0.3);
}

.form-input::placeholder {
  color: #6b7280;
}

.form-error {
  color: #ef4444;
  font-size: 0.875rem;
  margin-top: 0.5rem;
  display: none;
}

.form-error.show {
  display: block;
}

.btn-login {
  width: 100%;
  background: linear-gradient(135deg, #670676, #8800aa);
  border: none;
  border-radius: 8px;
  padding: 1rem;
  color: #fff;
  font-weight: bold;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(103, 6, 118, 0.3);
}

.btn-login:hover {
  transform: scale(1.02);
  box-shadow: 0 6px 20px rgba(103, 6, 118, 0.5);
}

.guest-login {
  margin-top: 1rem;
  text-align: center;
}

.guest-link {
  color: #a855f7;
  text-decoration: underline;
  cursor: pointer;
  transition: all 0.3s;
}

.guest-link:hover {
  color: #ec4899;
}

.app-container {
  display: none;
}

.app-container.active {
  display: block;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 1rem;
  background: rgba(103, 6, 118, 0.2);
  border: 1px solid rgba(103, 6, 118, 0.3);
  border-radius: 8px;
  padding: 0.5rem 1rem;
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, #a855f7, #ec4899);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 0.9rem;
}

.user-name {
  color: #a855f7;
  font-weight: 600;
}

.header-btn.logout {
  background: rgba(220, 38, 38, 0.2);
  border-color: rgba(220, 38, 38, 0.3);
  color: #ef4444;
}

.header-btn.logout:hover {
  background: rgba(220, 38, 38, 0.4);
}

.account-details {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.account-info-item {
  background: rgba(103, 6, 118, 0.1);
  border: 1px solid rgba(103, 6, 118, 0.2);
  border-radius: 8px;
  padding: 1rem;
}

.account-info-label {
  color: #9ca3af;
  font-size: 0.875rem;
  margin-bottom: 0.5rem;
}

.account-info-value {
  color: #fff;
  font-size: 1.125rem;
  font-weight: 600;
}

@media (max-width: 768px) {
  .login-container {
    padding: 2rem;
  }
}

.memo-content-preview {
  color: #d1d5db;
  line-height: 1.6;
  word-break: break-word;
}

::-webkit-scrollbar {
  width: 10px;
}

::-webkit-scrollbar-track {
  background: rgba(103, 6, 118, 0.1);
}

::-webkit-scrollbar-thumb {
  background: #670676;
  border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
  background: #8800aa;
}
</style>
</head>
<body>
  <div class="login-screen" id="loginScreen">
    <div class="login-container">
      <div class="login-logo">üìù</div>
      <h1 class="login-title">Todo & Memo</h1>

      <div class="login-tabs">
        <button class="login-tab active" data-tab="login">„É≠„Ç∞„Ç§„É≥</button>
        <button class="login-tab" data-tab="register">Êñ∞Ë¶èÁôªÈå≤</button>
      </div>

      <form class="login-form active" id="loginForm">
        <div class="form-group">
          <label class="form-label">„É¶„Éº„Ç∂„ÉºÂêç</label>
          <input type="text" class="form-input" id="loginUsername" placeholder="„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" required>
          <div class="form-error" id="loginUsernameError"></div>
        </div>
        
        <div class="form-group">
          <label class="form-label">„Éë„Çπ„ÉØ„Éº„Éâ</label>
          <input type="password" class="form-input" id="loginPassword" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" required>
          <div class="form-error" id="loginPasswordError"></div>
        </div>

        <button type="submit" class="btn-login">„É≠„Ç∞„Ç§„É≥</button>
      </form>

      <div class="guest-login">
        <span class="guest-link" onclick="loginAsGuest()">„Ç≤„Çπ„Éà„Å®„Åó„Å¶Á∂ö„Åë„Çã</span>
      </div>

      <form class="register-form" id="registerForm">
        <div class="form-group">
          <label class="form-label">„É¶„Éº„Ç∂„ÉºÂêç</label>
          <input type="text" class="form-input" id="registerUsername" placeholder="„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" required>
          <div class="form-error" id="registerUsernameError"></div>
        </div>

        <div class="form-group">
          <label class="form-label">„É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÔºà‰ªªÊÑèÔºâ</label>
          <input type="email" class="form-input" id="registerEmail" placeholder="email@example.com">
          <div class="form-error" id="registerEmailError"></div>
        </div>

        <div class="form-group">
          <label class="form-label">„Éë„Çπ„ÉØ„Éº„Éâ</label>
          <input type="password" class="form-input" id="registerPassword" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" required>
          <div class="form-error" id="registerPasswordError"></div>
        </div>

        <div class="form-group">
          <label class="form-label">„Éë„Çπ„ÉØ„Éº„ÉâÔºàÁ¢∫Ë™çÔºâ</label>
          <input type="password" class="form-input" id="registerPasswordConfirm" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÜçÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" required>
          <div class="form-error" id="registerPasswordConfirmError"></div>
        </div>

        <button type="submit" class="btn-login">„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê</button>
      </form>
    </div>
  </div>

  <div class="app-container" id="appContainer">

<header>
  <nav>
    <div class="logo">üìù Todo & Memo</div>
    <div class="user-info">
      <div class="user-avatar" id="userAvatar"></div>
      <div class="user-name" id="userName"></div>
    </div>
    <div class="header-actions">
      <button class="header-btn" onclick="openSearch()">üîç Ê§úÁ¥¢</button>
      <button class="header-btn" onclick="showStats()">üìä Áµ±Ë®à</button>
      <button class="header-btn" onclick="showKeyboardShortcuts()">‚å®Ô∏è „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà</button>
      <button class="header-btn" onclick="openSettings()">‚öôÔ∏è Ë®≠ÂÆö</button>
      <button class="header-btn" id="langSwitcher">EN</button>
    </div>
  </nav>
</header>

<div class="modal" id="accountModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeAccountModal()">‚úï</button>
    <h2 class="modal-title">üë§ „Ç¢„Ç´„Ç¶„É≥„ÉàÊÉÖÂ†±</h2>
    <div class="account-details">
      <div class="account-info-item">
        <div class="account-info-label">„É¶„Éº„Ç∂„ÉºÂêç</div>
        <div class="account-info-value" id="accountUsername"></div>
      </div>
      <div class="account-info-item">
        <div class="account-info-label">„Ç¢„Ç´„Ç¶„É≥„ÉàÁ®ÆÈ°û</div>
        <div class="account-info-value" id="accountType"></div>
      </div>
      <div class="account-info-item">
        <div class="account-info-label">Á∑èTodoÊï∞</div>
        <div class="account-info-value" id="accountTotalTodos"></div>
      </div>
      <div class="account-info-item">
        <div class="account-info-label">Á∑è„É°„É¢Êï∞</div>
        <div class="account-info-value" id="accountTotalMemos"></div>
      </div>
      <div class="modal-actions" style="margin-top: 1.5rem;">
        <button class="modal-btn modal-btn-secondary" onclick="closeAccountModal()">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>
</div>

<main>
  <div class="mode-switcher">
    <button class="mode-btn active" data-mode="todo">üìù Todo„É™„Çπ„Éà</button>
    <button class="mode-btn" data-mode="memo">üìÑ „É°„É¢</button>
  </div>

  <div class="content-area">
    <div class="todo-container active">
      <h1>„Çø„Çπ„ÇØÁÆ°ÁêÜ</h1>
      
      <div class="input-section">
        <input type="text" id="todoInput" placeholder="‰Ωï„Çí„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÅãÔºü">
        <button class="btn-primary" id="addTodoBtn">„Çø„Çπ„ÇØËøΩÂä†</button>
      </div>

      <div class="sort-controls">
        <span class="sort-label">‰∏¶„Å≥Êõø„Åà:</span>
        <select class="sort-select" id="todoSort">
          <option value="newest">Êñ∞„Åó„ÅÑÈ†Ü</option>
          <option value="oldest">Âè§„ÅÑÈ†Ü</option>
          <option value="priority">ÂÑ™ÂÖàÂ∫¶È†Ü</option>
          <option value="duedate">ÊúüÈôêÈ†Ü</option>
          <option value="alphabetical">„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„ÉàÈ†Ü</option>
        </select>
      </div>

      <div class="filter-tabs">
        <button class="filter-btn active" data-filter="all">„Åô„Åπ„Å¶</button>
        <button class="filter-btn" data-filter="active">Êú™ÂÆå‰∫Ü</button>
        <button class="filter-btn" data-filter="completed">ÂÆå‰∫ÜÊ∏à„Åø</button>
        <button class="filter-btn" data-filter="high">ÂÑ™ÂÖàÂ∫¶: È´ò</button>
        <button class="filter-btn" data-filter="medium">ÂÑ™ÂÖàÂ∫¶: ‰∏≠</button>
        <button class="filter-btn" data-filter="low">ÂÑ™ÂÖàÂ∫¶: ‰Ωé</button>
        <button class="filter-btn" data-filter="overdue">ÊúüÈôêÂàá„Çå</button>
      </div>

      <ul class="todo-list" id="todoList"></ul>

      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="totalTasks">0</div>
          <div class="stat-label">ÂêàË®à</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="activeTasks">0</div>
          <div class="stat-label">Êú™ÂÆå‰∫Ü</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="completedTasks">0</div>
          <div class="stat-label">ÂÆå‰∫ÜÊ∏à„Åø</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="completionRate">0%</div>
          <div class="stat-label">ÈÅîÊàêÁéá</div>
        </div>
      </div>

      <div class="export-section">
        <button class="btn-success" onclick="exportAllTodos()">üì• „Åô„Åπ„Å¶„ÅÆ„Çø„Çπ„ÇØ„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
        <button class="btn-primary" onclick="clearCompleted()">üóëÔ∏è ÂÆå‰∫ÜÊ∏à„Åø„ÇíÂâäÈô§</button>
      </div>
    </div>

    <div class="memo-container">
      <h1>„É°„É¢ÁÆ°ÁêÜ</h1>
      
      <div class="memo-input-section">
        <input type="text" id="memoTitle" placeholder="„É°„É¢„Çø„Ç§„Éà„É´...">
        
        <div class="view-toggle">
          <button class="view-btn active" id="editViewBtn" onclick="switchMemoView('edit')">‚úèÔ∏è Á∑®ÈõÜ</button>
          <button class="view-btn" id="previewViewBtn" onclick="switchMemoView('preview')">üëÅÔ∏è „Éó„É¨„Éì„É•„Éº</button>
        </div>
        
        <div class="memo-toolbar">
          <button class="toolbar-btn" onclick="insertText('**Â§™Â≠ó**')" title="Â§™Â≠ó (ÈÅ∏ÊäûÁØÑÂõ≤„ÇíÂ§™Â≠ó„Å´)">
            <strong>B</strong>
          </button>
          <button class="toolbar-btn" onclick="insertText('*Êñú‰Ωì*')" title="Êñú‰Ωì (ÈÅ∏ÊäûÁØÑÂõ≤„ÇíÊñú‰Ωì„Å´)">
            <em>I</em>
          </button>
          <button class="toolbar-btn" onclick="insertText('~~Êâì„Å°Ê∂à„ÅóÁ∑ö~~')" title="Êâì„Å°Ê∂à„ÅóÁ∑ö">
            <s>S</s>
          </button>
          <button class="toolbar-btn" onclick="insertText('# ')" title="Ë¶ãÂá∫„Åó1">H1</button>
          <button class="toolbar-btn" onclick="insertText('## ')" title="Ë¶ãÂá∫„Åó2">H2</button>
          <button class="toolbar-btn" onclick="insertText('### ')" title="Ë¶ãÂá∫„Åó3">H3</button>
          <button class="toolbar-btn" onclick="insertText('- ')" title="ÁÆáÊù°Êõ∏„Åç">‚Ä¢ List</button>
          <button class="toolbar-btn" onclick="insertText('1. ')" title="Áï™Âè∑‰ªò„Åç„É™„Çπ„Éà">1. List</button>
          <button class="toolbar-btn" onclick="insertText('[ ] ')" title="„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ">‚òê Task</button>
          <button class="toolbar-btn" onclick="insertText('```\n\n```')" title="„Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ">&lt;/&gt; Code</button>
          <button class="toolbar-btn" onclick="insertText('> ')" title="ÂºïÁî®">‚ùù Quote</button>
          <button class="toolbar-btn" onclick="insertLink()" title="„É™„É≥„ÇØ">üîó Link</button>
          <button class="toolbar-btn" onclick="insertImage()" title="ÁîªÂÉè">üñºÔ∏è Image</button>
          <button class="toolbar-btn" onclick="insertTable()" title="„ÉÜ„Éº„Éñ„É´">üìä Table</button>
          <button class="toolbar-btn" onclick="insertHorizontalRule()" title="Ê∞¥Âπ≥Á∑ö">‚îÄ HR</button>
        </div>
        
        <textarea id="memoContent" placeholder="„É°„É¢„Çí„Åì„Åì„Å´Êõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ...&#10;&#10;Markdown„Çí„Çµ„Éù„Éº„Éà:&#10;**Â§™Â≠ó** *Êñú‰Ωì* ~~Êâì„Å°Ê∂à„ÅóÁ∑ö~~&#10;# Ë¶ãÂá∫„Åó1 ## Ë¶ãÂá∫„Åó2 ### Ë¶ãÂá∫„Åó3&#10;- „É™„Çπ„Éà 1. Áï™Âè∑‰ªò„Åç„É™„Çπ„Éà [ ] „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ&#10;> ÂºïÁî® ``` „Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ ``` [„É™„É≥„ÇØ](URL)"></textarea>
        
        <div id="memoPreview" class="memo-preview"></div>
        
        <input type="text" id="memoTags" placeholder="„Çø„Ç∞ („Ç´„É≥„ÉûÂå∫Âàá„Çä: ‰ªï‰∫ã, „Ç¢„Ç§„Éá„Ç¢, ÈáçË¶Å)">
        
        <button class="btn-primary" id="addMemoBtn">„É°„É¢„Çí‰øùÂ≠ò</button>
      </div>

      <div class="sort-controls">
        <span class="sort-label">‰∏¶„Å≥Êõø„Åà:</span>
        <select class="sort-select" id="memoSort">
          <option value="newest">Êñ∞„Åó„ÅÑÈ†Ü</option>
          <option value="oldest">Âè§„ÅÑÈ†Ü</option>
          <option value="alphabetical">„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„ÉàÈ†Ü</option>
          <option value="longest">Èï∑„ÅÑÈ†Ü</option>
        </select>
      </div>

      <div class="memo-filters" id="memoFilters">
        <button class="filter-btn active" onclick="filterMemosByTag('all')">„Åô„Åπ„Å¶</button>
      </div>

      <div class="export-section">
        <button class="btn-success" onclick="exportAllMemos()">üì• „Åô„Åπ„Å¶„ÅÆ„É°„É¢„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
      </div>

      <div class="memo-list" id="memoList"></div>
    </div>
  </div>
</main>
</div>

<div class="modal" id="searchModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeSearch()">‚úï</button>
    <h2 class="modal-title">üîç Ê§úÁ¥¢</h2>
    <input type="text" class="modal-input" id="searchInput" placeholder="„Çø„Çπ„ÇØ„ÇÑ„É°„É¢„ÇíÊ§úÁ¥¢...">
    <div class="search-results" id="searchResults"></div>
  </div>
</div>

<div class="modal" id="editTodoModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeEditTodoModal()">‚úï</button>
    <h2 class="modal-title">üìù „Çø„Çπ„ÇØ„ÇíÁ∑®ÈõÜ</h2>
    <input type="text" class="modal-input" id="editTodoText" placeholder="„Çø„Çπ„ÇØ„ÅÆÂÜÖÂÆπ">
    <select class="modal-select" id="editTodoPriority">
      <option value="">ÂÑ™ÂÖàÂ∫¶„Å™„Åó</option>
      <option value="high">È´ò</option>
      <option value="medium">‰∏≠</option>
      <option value="low">‰Ωé</option>
    </select>
    <input type="date" class="modal-input" id="editTodoDueDate" placeholder="ÊúüÈôê">
    <input type="text" class="modal-input" id="editTodoTags" placeholder="„Çø„Ç∞ („Ç´„É≥„ÉûÂå∫Âàá„Çä)">
    <textarea class="modal-textarea" id="editTodoNote" placeholder="„É°„É¢"></textarea>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeEditTodoModal()">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="modal-btn modal-btn-primary" onclick="saveEditedTodo()">‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<div class="modal" id="statsModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeStats()">‚úï</button>
    <h2 class="modal-title">üìä Áµ±Ë®àÊÉÖÂ†±</h2>
    <div id="statsContent"></div>
  </div>
</div>

<div class="modal" id="settingsModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeSettings()">‚úï</button>
    <h2 class="modal-title">‚öôÔ∏è Ë®≠ÂÆö</h2>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="importData()">üì§ „Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà</button>
      <button class="modal-btn modal-btn-primary" onclick="exportAllData()">üì• „Åô„Åπ„Å¶„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
      <button class="modal-btn modal-btn-secondary" onclick="clearAllData()">üóëÔ∏è „Åô„Åπ„Å¶„ÇíÂâäÈô§</button>
    </div>
  </div>
</div>

<div class="modal" id="shortcutsModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeKeyboardShortcuts()">‚úï</button>
    <h2 class="modal-title">‚å®Ô∏è „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà</h2>
    <div class="shortcuts-list">
      <div class="shortcut-section">
        <h3>ÂÖ®Ëà¨</h3>
        <div class="shortcut-item">
          <kbd>Ctrl/Cmd + K</kbd>
          <span>Ê§úÁ¥¢„ÇíÈñã„Åè</span>
        </div>
        <div class="shortcut-item">
          <kbd>Esc</kbd>
          <span>„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã</span>
        </div>
      </div>
      
      <div class="shortcut-section">
        <h3>„É°„É¢Á∑®ÈõÜ</h3>
        <div class="shortcut-item">
          <kbd>Ctrl/Cmd + B</kbd>
          <span>Â§™Â≠ó</span>
        </div>
        <div class="shortcut-item">
          <kbd>Ctrl/Cmd + I</kbd>
          <span>Êñú‰Ωì</span>
        </div>
        <div class="shortcut-item">
          <kbd>Ctrl/Cmd + K</kbd>
          <span>„É™„É≥„ÇØÊåøÂÖ•</span>
        </div>
        <div class="shortcut-item">
          <kbd>Ctrl/Cmd + Shift + K</kbd>
          <span>„Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ</span>
        </div>
        <div class="shortcut-item">
          <kbd>Ctrl/Cmd + Enter</kbd>
          <span>„É°„É¢„Çí‰øùÂ≠ò</span>
        </div>
      </div>
      
      <div class="shortcut-section">
        <h3>Todo</h3>
        <div class="shortcut-item">
          <kbd>Enter</kbd>
          <span>„Çø„Çπ„ÇØ„ÇíËøΩÂä†</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="confirm-dialog" id="confirmDialog">
  <div class="confirm-dialog-content">
    <div class="confirm-dialog-title" id="confirmTitle">Á¢∫Ë™ç</div>
    <div class="confirm-dialog-message" id="confirmMessage">„Åì„ÅÆÊìç‰Ωú„ÇíÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü</div>
    <div class="confirm-dialog-actions">
      <button class="confirm-btn confirm-btn-cancel" id="confirmCancelBtn">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="confirm-btn confirm-btn-danger" id="confirmOkBtn">OK</button>
    </div>
  </div>
</div>

<script>
// „Éá„Éº„ÇøÁÆ°ÁêÜ
let todos = [];
let memos = [];
let currentFilter = 'all';
let currentMemoFilter = 'all';
let editingTodoId = null;
let currentLang = 'ja';
let allMemoTags = new Set();
let currentTodoSort = 'newest';
let currentMemoSort = 'newest';
let currentMemoView = 'edit';
let todoSortable = null;
let currentUser = null;

class AccountManager {
  constructor() {
    this.users = this.loadUsers();
  }

  loadUsers() {
    try {
      const stored = localStorage.getItem('users');
      return stored ? JSON.parse(stored) : {};
    } catch (e) {
      console.error('„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
      return {};
    }
  }

  saveUsers() {
    try {
      localStorage.setItem('users', JSON.stringify(this.users));
    } catch (e) {
      console.error('„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„Ç®„É©„Éº:', e);
    }
  }

  register(username, password, email = '') {
    if (this.users[username]) {
      return { success: false, error: '„Åì„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç„ÅØÊó¢„Å´‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô' };
    }

    if (username.length < 3) {
      return { success: false, error: '„É¶„Éº„Ç∂„ÉºÂêç„ÅØ3ÊñáÂ≠ó‰ª•‰∏ä„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô' };
    }

    if (password.length < 6) {
      return { success: false, error: '„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô' };
    }

    this.users[username] = {
      password: this.hashPassword(password),
      email: email,
      createdAt: new Date().toISOString(),
      isGuest: false
    };

    this.saveUsers();
    return { success: true };
  }

  login(username, password) {
    const user = this.users[username];
    
    if (!user) {
      return { success: false, error: '„É¶„Éº„Ç∂„ÉºÂêç„Åæ„Åü„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì' };
    }

    if (user.password !== this.hashPassword(password)) {
      return { success: false, error: '„É¶„Éº„Ç∂„ÉºÂêç„Åæ„Åü„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì' };
    }

    return { 
      success: true, 
      user: { 
        username, 
        email: user.email, 
        createdAt: user.createdAt, 
        isGuest: user.isGuest 
      } 
    };
  }

  loginAsGuest() {
    const guestUsername = 'guest_' + Date.now();
    this.users[guestUsername] = {
      password: this.hashPassword('guest'),
      email: '',
      createdAt: new Date().toISOString(),
      isGuest: true
    };
    this.saveUsers();
    
    return { 
      success: true, 
      user: { 
        username: guestUsername, 
        email: '', 
        createdAt: this.users[guestUsername].createdAt,
        isGuest: true 
      } 
    };
  }

  hashPassword(password) {
    let hash = 0;
    for (let i = 0; i < password.length; i++) {
      const char = password.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return hash.toString();
  }
}

const accountManager = new AccountManager();

function loginAsGuest() {
  const result = accountManager.loginAsGuest();
  if (result.success) {
    loginUser(result.user);
  }
}

function loginUser(user) {
  currentUser = user;
  
  try {
    sessionStorage.setItem('currentUser', JSON.stringify(user));
  } catch (e) {
    console.error('„Çª„ÉÉ„Ç∑„Éß„É≥‰øùÂ≠ò„Ç®„É©„Éº:', e);
  }
  
  document.getElementById('userName').textContent = user.isGuest ? '„Ç≤„Çπ„Éà' : user.username;
  document.getElementById('userAvatar').textContent = user.isGuest ? 'üë§' : user.username.charAt(0).toUpperCase();
  
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('appContainer').classList.add('active');
  
  loadUserData();
}

function logout() {
  currentUser = null;
  sessionStorage.removeItem('currentUser');
  
  saveUserData();
  
  todos = [];
  memos = [];
  renderTodos();
  renderMemos();
  
  document.getElementById('appContainer').classList.remove('active');
  document.getElementById('loginScreen').style.display = 'flex';
  
  document.getElementById('loginForm').reset();
  document.getElementById('registerForm').reset();
  document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));
}

function openAccountModal() {
  if (!currentUser) return;
  
  document.getElementById('accountUsername').textContent = 
    currentUser.isGuest ? '„Ç≤„Çπ„Éà„É¶„Éº„Ç∂„Éº' : currentUser.username;
  
  document.getElementById('accountType').textContent = 
    currentUser.isGuest ? '„Ç≤„Çπ„Éà' : 'ÁôªÈå≤„É¶„Éº„Ç∂„Éº';
  
  document.getElementById('accountTotalTodos').textContent = todos.length;
  document.getElementById('accountTotalMemos').textContent = memos.length;
  
  document.getElementById('accountModal').classList.add('active');
}

function closeAccountModal() {
  document.getElementById('accountModal').classList.remove('active');
}

function loadUserData() {
  if (!currentUser) return;
  
  const userDataKey = `userData_${currentUser.username}`;
  
  try {
    const stored = localStorage.getItem(userDataKey);
    if (stored) {
      const data = JSON.parse(stored);
      todos = data.todos || [];
      memos = data.memos || [];
    } else {
      todos = [];
      memos = [];
    }
  } catch (e) {
    console.error('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
    todos = [];
    memos = [];
  }
  
  updateMemoTags();
  renderTodos();
  renderMemos();
}

function saveUserData() {
  if (!currentUser) return;
  
  const userDataKey = `userData_${currentUser.username}`;
  
  try {
    const data = {
      todos: todos,
      memos: memos,
      lastSaved: new Date().toISOString()
    };
    localStorage.setItem(userDataKey, JSON.stringify(data));
  } catch (e) {
    console.error('„Éá„Éº„Çø‰øùÂ≠ò„Ç®„É©„Éº:', e);
  }
}

if (typeof marked !== 'undefined') {
  marked.setOptions({
    breaks: true,
    gfm: true
  });
}

function customConfirm(message, title = 'Á¢∫Ë™ç', showCancel = true) {
  return new Promise((resolve) => {
    const dialog = document.getElementById('confirmDialog');
    const titleEl = document.getElementById('confirmTitle');
    const messageEl = document.getElementById('confirmMessage');
    const okBtn = document.getElementById('confirmOkBtn');
    const cancelBtn = document.getElementById('confirmCancelBtn');
    
    titleEl.textContent = title;
    messageEl.textContent = message;
    
    if (showCancel) {
      cancelBtn.style.display = 'block';
    } else {
      cancelBtn.style.display = 'none';
    }
    
    dialog.classList.add('active');
    
    const handleOk = () => {
      dialog.classList.remove('active');
      document.removeEventListener('keydown', handleEsc);
      okBtn.removeEventListener('click', handleOk);
      cancelBtn.removeEventListener('click', handleCancel);
      resolve(true);
    };
    
    const handleCancel = () => {
      dialog.classList.remove('active');
      document.removeEventListener('keydown', handleEsc);
      okBtn.removeEventListener('click', handleOk);
      cancelBtn.removeEventListener('click', handleCancel);
      resolve(false);
    };
    
    const handleEsc = (e) => {
      if (e.key === 'Escape') {
        if (showCancel) {
          handleCancel();
        } else {
          handleOk();
        }
      }
    };
    
    okBtn.addEventListener('click', handleOk);
    cancelBtn.addEventListener('click', handleCancel);
    document.addEventListener('keydown', handleEsc);
  });
}

function switchMemoView(view) {
  currentMemoView = view;
  const textarea = document.getElementById('memoContent');
  const preview = document.getElementById('memoPreview');
  const editBtn = document.getElementById('editViewBtn');
  const previewBtn = document.getElementById('previewViewBtn');
  
  if (view === 'edit') {
    textarea.style.display = 'block';
    preview.classList.remove('active');
    editBtn.classList.add('active');
    previewBtn.classList.remove('active');
  } else {
    textarea.style.display = 'none';
    preview.classList.add('active');
    editBtn.classList.remove('active');
    previewBtn.classList.add('active');
    updateMemoPreview();
  }
}

function updateMemoPreview() {
  const content = document.getElementById('memoContent').value;
  const preview = document.getElementById('memoPreview');
  
  if (typeof marked !== 'undefined') {
    preview.innerHTML = marked.parse(content || '*„Éó„É¨„Éì„É•„Éº„Åô„ÇãÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì*');
  } else {
    preview.innerHTML = content.replace(/\n/g, '<br>');
  }
}

document.addEventListener('DOMContentLoaded', function() {
  const loginForm = document.getElementById('loginForm');
  if (loginForm) {
    loginForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));
      
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      if (!username || !password) {
        document.getElementById('loginPasswordError').textContent = '„Åô„Åπ„Å¶„ÅÆ„Éï„Ç£„Éº„É´„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        document.getElementById('loginPasswordError').classList.add('show');
        return;
      }

      const result = accountManager.login(username, password);
      if (result.success) {
        loginUser(result.user);
      } else {
        document.getElementById('loginPasswordError').textContent = result.error;
        document.getElementById('loginPasswordError').classList.add('show');
      }
    });
  }

  const registerForm = document.getElementById('registerForm');
  if (registerForm) {
    registerForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));
      
      const username = document.getElementById('registerUsername').value.trim();
      const email = document.getElementById('registerEmail').value.trim();
      const password = document.getElementById('registerPassword').value;
      const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
      
      if (!username || !password || !passwordConfirm) {
        document.getElementById('registerPasswordConfirmError').textContent = 
          '„É¶„Éº„Ç∂„ÉºÂêç„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÅØÂøÖÈ†à„Åß„Åô';
        document.getElementById('registerPasswordConfirmError').classList.add('show');
        return;
      }

      if (password !== passwordConfirm) {
        document.getElementById('registerPasswordConfirmError').textContent = 
          '„Éë„Çπ„ÉØ„Éº„Éâ„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì';
        document.getElementById('registerPasswordConfirmError').classList.add('show');
        return;
      }

      const result = accountManager.register(username, password, email);
      if (result.success) {
        const loginResult = accountManager.login(username, password);
        if (loginResult.success) {
          loginUser(loginResult.user);
        }
      } else {
        document.getElementById('registerUsernameError').textContent = result.error;
        document.getElementById('registerUsernameError').classList.add('show');
      }
    });
  }

  document.querySelectorAll('.login-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const targetTab = this.dataset.tab;
      
      document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));
      
      document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      document.querySelectorAll('.login-form, .register-form')
        .forEach(f => f.classList.remove('active'));
      
      if (targetTab === 'login') {
        document.getElementById('loginForm').classList.add('active');
      } else {
        document.getElementById('registerForm').classList.add('active');
      }
    });
  });

  const userInfo = document.querySelector('.user-info');
  if (userInfo) {
    userInfo.addEventListener('click', openAccountModal);
    userInfo.style.cursor = 'pointer';
  }

  const memoContent = document.getElementById('memoContent');
  if (memoContent) {
    memoContent.addEventListener('input', function() {
      if (currentMemoView === 'preview') {
        updateMemoPreview();
      }
    });
  }
});

const translations = {
  ja: {
    app_title: 'Todo & Memo',
    search: 'Ê§úÁ¥¢',
    stats: 'Áµ±Ë®à',
    settings: 'Ë®≠ÂÆö',
    todo_mode: 'Todo„É™„Çπ„Éà',
    memo_mode: '„É°„É¢',
    task_management: 'Todo',
    memo_management: 'Memo',
    add_task: 'TodoËøΩÂä†',
    add_memo: 'Memo„Çí‰øùÂ≠ò',
    task_placeholder: '‰Ωï„Çí„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÅãÔºü',
    memo_title_placeholder: '„É°„É¢„Çø„Ç§„Éà„É´...',
    memo_content_placeholder: '„É°„É¢„Çí„Åì„Åì„Å´Êõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ...',
    tags_placeholder: '„Çø„Ç∞ („Ç´„É≥„ÉûÂå∫Âàá„Çä: ‰ªï‰∫ã, „Ç¢„Ç§„Éá„Ç¢, ÈáçË¶Å)',
    sort_by: '‰∏¶„Å≥Êõø„Åà:',
    sort_newest: 'Êñ∞„Åó„ÅÑÈ†Ü',
    sort_oldest: 'Âè§„ÅÑÈ†Ü',
    sort_priority: 'ÂÑ™ÂÖàÂ∫¶È†Ü',
    sort_duedate: 'ÊúüÈôêÈ†Ü',
    sort_alphabetical: '„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„ÉàÈ†Ü',
    sort_longest: 'Èï∑„ÅÑÈ†Ü',
    filter_all: '„Åô„Åπ„Å¶',
    filter_active: 'Êú™ÂÆå‰∫Ü',
    filter_completed: 'ÂÆå‰∫ÜÊ∏à„Åø',
    filter_high: 'ÂÑ™ÂÖàÂ∫¶: È´ò',
    filter_medium: 'ÂÑ™ÂÖàÂ∫¶: ‰∏≠',
    filter_low: 'ÂÑ™ÂÖàÂ∫¶: ‰Ωé',
    filter_overdue: 'ÊúüÈôêÂàá„Çå',
    stat_total: 'ÂêàË®à',
    stat_active: 'Êú™ÂÆå‰∫Ü',
    stat_completed: 'ÂÆå‰∫ÜÊ∏à„Åø',
    stat_completion_rate: 'ÈÅîÊàêÁéá',
    export_all_tasks: '„Åô„Åπ„Å¶„ÅÆ„Çø„Çπ„ÇØ„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà',
    export_all_memos: '„Åô„Åπ„Å¶„ÅÆ„É°„É¢„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà',
    clear_completed: 'ÂÆå‰∫ÜÊ∏à„Åø„ÇíÂâäÈô§',
    no_tasks: '„Çø„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì',
    no_memos: '„Åæ„Å†„É°„É¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',
    delete_btn: 'ÂâäÈô§',
    export_btn: '„Ç®„ÇØ„Çπ„Éù„Éº„Éà',
    edit_btn: 'Á∑®ÈõÜ',
    duplicate_btn: 'Ë§áË£Ω',
    priority_high: 'È´ò',
    priority_medium: '‰∏≠',
    priority_low: '‰Ωé',
    priority_none: 'ÂÑ™ÂÖàÂ∫¶„Å™„Åó',
    untitled: 'ÁÑ°È°å',
    due_today: '‰ªäÊó•',
    due_tomorrow: 'ÊòéÊó•',
    overdue: 'ÊúüÈôêÂàá„Çå',
    completed: 'ÂÆå‰∫Ü',
    active: 'Êú™ÂÆå‰∫Ü',
    edit_task: '„Çø„Çπ„ÇØ„ÇíÁ∑®ÈõÜ',
    task_content: '„Çø„Çπ„ÇØ„ÅÆÂÜÖÂÆπ',
    due_date: 'ÊúüÈôê',
    note: '„É°„É¢',
    cancel: '„Ç≠„É£„É≥„Çª„É´',
    save: '‰øùÂ≠ò',
    stats_title: 'Áµ±Ë®àÊÉÖÂ†±',
    total_tasks: 'Á∑è„Çø„Çπ„ÇØÊï∞',
    active_tasks: 'Êú™ÂÆå‰∫Ü„Çø„Çπ„ÇØ',
    completed_tasks: 'ÂÆå‰∫ÜÊ∏à„Åø„Çø„Çπ„ÇØ',
    high_priority_tasks: 'È´òÂÑ™ÂÖàÂ∫¶„Çø„Çπ„ÇØ',
    total_memos: 'Á∑è„É°„É¢Êï∞',
    tags_in_use: '‰ΩøÁî®‰∏≠„ÅÆ„Çø„Ç∞',
    settings_title: 'Ë®≠ÂÆö',
    import_data: '„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà',
    export_data: '„Åô„Åπ„Å¶„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà',
    clear_all: '„Åô„Åπ„Å¶„ÇíÂâäÈô§',
    search_title: 'Ê§úÁ¥¢',
    search_placeholder: '„Çø„Çπ„ÇØ„ÇÑ„É°„É¢„ÇíÊ§úÁ¥¢...',
    no_results: 'Ê§úÁ¥¢ÁµêÊûú„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì',
    confirm_delete_task: '„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„Åã?',
    confirm_delete_memo: '„Åì„ÅÆ„É°„É¢„ÇíÂâäÈô§„Åó„Åæ„Åô„Åã?',
    confirm_clear_completed: 'ÂÆå‰∫ÜÊ∏à„Åø„ÅÆ„Çø„Çπ„ÇØ„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„Åã?',
    confirm_import: '„Ç§„É≥„Éù„Éº„Éà„Åô„Çã„Å®ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Åå‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇÁ∂ö„Åë„Åæ„Åô„Åã?',
    confirm_clear_all_1: '„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„Åã? „Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ',
    confirm_clear_all_2: 'Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„Åã?',
    import_success: '„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü!',
    import_error: '„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü',
    no_tasks_export: '„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',
    no_memos_export: '„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„É°„É¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'
  },
  en: {
    app_title: 'Todo & Memo',
    search: 'Search',
    stats: 'Stats',
    settings: 'Settings',
    todo_mode: 'Todo List',
    memo_mode: 'Memos',
    task_management: 'Todo',
    memo_management: 'Memo',
    add_task: 'Add Todo',
    add_memo: 'Save Memo',
    task_placeholder: 'What do you need to do?',
    memo_title_placeholder: 'Memo title...',
    memo_content_placeholder: 'Write your memo here...',
    tags_placeholder: 'Tags (comma separated: work, ideas, important)',
    sort_by: 'Sort by:',
    sort_newest: 'Newest',
    sort_oldest: 'Oldest',
    sort_priority: 'Priority',
    sort_duedate: 'Due Date',
    sort_alphabetical: 'Alphabetical',
    sort_longest: 'Longest',
    filter_all: 'All',
    filter_active: 'Active',
    filter_completed: 'Completed',
    filter_high: 'Priority: High',
    filter_medium: 'Priority: Medium',
    filter_low: 'Priority: Low',
    filter_overdue: 'Overdue',
    stat_total: 'Total',
    stat_active: 'Active',
    stat_completed: 'Completed',
    stat_completion_rate: 'Completion Rate',
    export_all_tasks: 'Export All Tasks',
    export_all_memos: 'Export All Memos',
    clear_completed: 'Clear Completed',
    no_tasks: 'No tasks found',
    no_memos: 'No memos yet',
    delete_btn: 'Delete',
    export_btn: 'Export',
    edit_btn: 'Edit',
    duplicate_btn: 'Duplicate',
    priority_high: 'High',
    priority_medium: 'Medium',
    priority_low: 'Low',
    priority_none: 'No Priority',
    untitled: 'Untitled',
    due_today: 'Today',
    due_tomorrow: 'Tomorrow',
    overdue: 'Overdue',
    completed: 'Completed',
    active: 'Active',
    edit_task: 'Edit Task',
    task_content: 'Task content',
    due_date: 'Due Date',
    note: 'Note',
    cancel: 'Cancel',
    save: 'Save',
    stats_title: 'Statistics',
    total_tasks: 'Total Tasks',
    active_tasks: 'Active Tasks',
    completed_tasks: 'Completed Tasks',
    high_priority_tasks: 'High Priority Tasks',
    total_memos: 'Total Memos',
    tags_in_use: 'Tags in Use',
    settings_title: 'Settings',
    import_data: 'Import Data',
    export_data: 'Export All',
    clear_all: 'Clear All',
    search_title: 'Search',
    search_placeholder: 'Search tasks and memos...',
    no_results: 'No results found',
    confirm_delete_task: 'Delete this task?',
    confirm_delete_memo: 'Delete this memo?',
    confirm_clear_completed: 'Clear all completed tasks?',
    confirm_import: 'Importing will overwrite current data. Continue?',
    confirm_clear_all_1: 'Delete all data? This cannot be undone.',
    confirm_clear_all_2: 'Are you sure?',
    import_success: 'Data imported successfully!',
    import_error: 'Failed to load file',
    no_tasks_export: 'No tasks to export',
    no_memos_export: 'No memos to export'
  }
};

function updateUILanguage() {
  const t = translations[currentLang];
  
  document.querySelector('.logo').textContent = `üìù ${t.app_title}`;
  document.querySelectorAll('.header-btn')[0].textContent = `üîç ${t.search}`;
  document.querySelectorAll('.header-btn')[1].textContent = `üìä ${t.stats}`;
  document.querySelectorAll('.header-btn')[2].textContent = `‚öôÔ∏è ${t.settings}`;
  
  document.querySelector('[data-mode="todo"]').textContent = `üìù ${t.todo_mode}`;
  document.querySelector('[data-mode="memo"]').textContent = `üìÑ ${t.memo_mode}`;
  
  document.querySelector('.todo-container h1').textContent = t.task_management;
  document.getElementById('todoInput').placeholder = t.task_placeholder;
  document.getElementById('addTodoBtn').textContent = t.add_task;
  
  const todoSortOptions = document.querySelectorAll('#todoSort option');
  todoSortOptions[0].textContent = t.sort_newest;
  todoSortOptions[1].textContent = t.sort_oldest;
  todoSortOptions[2].textContent = t.sort_priority;
  todoSortOptions[3].textContent = t.sort_duedate;
  todoSortOptions[4].textContent = t.sort_alphabetical;
  
  const todoFilters = document.querySelectorAll('.filter-tabs .filter-btn');
  todoFilters[0].textContent = t.filter_all;
  todoFilters[1].textContent = t.filter_active;
  todoFilters[2].textContent = t.filter_completed;
  todoFilters[3].textContent = t.filter_high;
  todoFilters[4].textContent = t.filter_medium;
  todoFilters[5].textContent = t.filter_low;
  todoFilters[6].textContent = t.filter_overdue;
  
  document.querySelectorAll('.todo-container .stat-label')[0].textContent = t.stat_total;
  document.querySelectorAll('.todo-container .stat-label')[1].textContent = t.stat_active;
  document.querySelectorAll('.todo-container .stat-label')[2].textContent = t.stat_completed;
  document.querySelectorAll('.todo-container .stat-label')[3].textContent = t.stat_completion_rate;
  
  document.querySelectorAll('.todo-container .export-section button')[0].textContent = `üì• ${t.export_all_tasks}`;
  document.querySelectorAll('.todo-container .export-section button')[1].textContent = `üóëÔ∏è ${t.clear_completed}`;
  
  document.querySelector('.memo-container h1').textContent = t.memo_management;
  document.getElementById('memoTitle').placeholder = t.memo_title_placeholder;
  document.getElementById('memoContent').placeholder = t.memo_content_placeholder;
  document.getElementById('memoTags').placeholder = t.tags_placeholder;
  document.getElementById('addMemoBtn').textContent = t.add_memo;
  
  const memoSortLabel = document.querySelectorAll('.memo-container .sort-label')[0];
  if (memoSortLabel) memoSortLabel.textContent = t.sort_by;
  
  const memoSortOptions = document.querySelectorAll('#memoSort option');
  memoSortOptions[0].textContent = t.sort_newest;
  memoSortOptions[1].textContent = t.sort_oldest;
  memoSortOptions[2].textContent = t.sort_alphabetical;
  memoSortOptions[3].textContent = t.sort_longest;
  
  document.querySelectorAll('.memo-container .export-section button')[0].textContent = `üì• ${t.export_all_memos}`;
  
  document.querySelector('#editTodoModal .modal-title').textContent = `üìù ${t.edit_task}`;
  document.getElementById('editTodoText').placeholder = t.task_content;
  
  const priorityOptions = document.querySelectorAll('#editTodoPriority option');
  priorityOptions[0].textContent = t.priority_none;
  priorityOptions[1].textContent = t.priority_high;
  priorityOptions[2].textContent = t.priority_medium;
  priorityOptions[3].textContent = t.priority_low;
  
  document.getElementById('editTodoTags').placeholder = t.tags_placeholder;
  document.getElementById('editTodoNote').placeholder = t.note;
  
  document.querySelectorAll('#editTodoModal .modal-btn')[0].textContent = t.cancel;
  document.querySelectorAll('#editTodoModal .modal-btn')[1].textContent = t.save;
  
  document.querySelector('#searchModal .modal-title').textContent = `üîç ${t.search_title}`;
  document.getElementById('searchInput').placeholder = t.search_placeholder;
  
  document.querySelector('#statsModal .modal-title').textContent = `üìä ${t.stats_title}`;
  
  document.querySelector('#settingsModal .modal-title').textContent = `‚öôÔ∏è ${t.settings_title}`;
  const settingsButtons = document.querySelectorAll('#settingsModal .modal-btn');
  settingsButtons[0].textContent = `üì§ ${t.import_data}`;
  settingsButtons[1].textContent = `üì• ${t.export_data}`;
  settingsButtons[2].textContent = `üóëÔ∏è ${t.clear_all}`;
}

function saveTodos() {
  saveUserData();
}

function loadTodos() {
}

function saveMemos() {
  saveUserData();
}

function loadMemos() {
}

function addTodo() {
  const text = document.getElementById('todoInput').value.trim();
  if (!text) return;

  todos.unshift({
    id: Date.now(),
    text: text,
    completed: false,
    date: new Date().toLocaleString(currentLang === 'ja' ? 'ja-JP' : 'en-US'),
    priority: '',
    tags: [],
    dueDate: null,
    note: ''
  });

  document.getElementById('todoInput').value = '';
  saveTodos();
  renderTodos();
}

function toggleTodo(id) {
  const todo = todos.find(t => t.id === id);
  if (todo) {
    todo.completed = !todo.completed;
    if (todo.completed) {
      todo.completedDate = new Date().toLocaleString(currentLang === 'ja' ? 'ja-JP' : 'en-US');
    } else {
      delete todo.completedDate;
    }
    saveTodos();
    renderTodos();
  }
}

async function deleteTodo(id) {
  const t = translations[currentLang];
  const confirmed = await customConfirm(t.confirm_delete_task, '‚ö†Ô∏è ' + (currentLang === 'ja' ? 'ÂâäÈô§Á¢∫Ë™ç' : 'Confirm Delete'));
  
  if (confirmed) {
    const index = todos.findIndex(todo => todo.id === id);
    if (index !== -1) {
      todos.splice(index, 1);
      saveTodos();
      renderTodos();
    }
  }
}

function duplicateTodo(id) {
  const todo = todos.find(t => t.id === id);
  if (!todo) return;

  const t = translations[currentLang];
  const copyLabel = currentLang === 'ja' ? ' („Ç≥„Éî„Éº)' : ' (Copy)';

  todos.unshift({
    ...todo,
    id: Date.now(),
    completed: false,
    date: new Date().toLocaleString(currentLang === 'ja' ? 'ja-JP' : 'en-US'),
    text: todo.text + copyLabel
  });

  saveTodos();
  renderTodos();
}

function exportTodo(id) {
  const todo = todos.find(t => t.id === id);
  if (!todo) return;
  
  const t = translations[currentLang];

  let content = `${currentLang === 'ja' ? '„Çø„Çπ„ÇØ' : 'Task'}: ${todo.text}\n${'='.repeat(50)}\n\n`;
  content += `${currentLang === 'ja' ? 'Áä∂ÊÖã' : 'Status'}: ${todo.completed ? '‚úì ' + t.completed : '‚òê ' + t.active}\n`;
  
  if (todo.priority) {
    content += `${currentLang === 'ja' ? 'ÂÑ™ÂÖàÂ∫¶' : 'Priority'}: ${t['priority_' + todo.priority]}\n`;
  }
  
  if (todo.dueDate) {
    content += `${currentLang === 'ja' ? 'ÊúüÈôê' : 'Due Date'}: ${new Date(todo.dueDate).toLocaleDateString(currentLang === 'ja' ? 'ja-JP' : 'en-US')}\n`;
  }
  
  if (todo.tags && todo.tags.length > 0) {
    content += `${currentLang === 'ja' ? '„Çø„Ç∞' :'Tags'}: ${todo.tags.join(', ')}\n`;
  }
  
  if (todo.note) {
    content += `\n${currentLang === 'ja' ? '„É°„É¢' : 'Note'}:\n${todo.note}\n`;
  }
  
  content += `\n${currentLang === 'ja' ? '‰ΩúÊàêÊó•ÊôÇ' : 'Created'}: ${todo.date || (currentLang === 'ja' ? '‰∏çÊòé' : 'Unknown')}`;
  
  if (todo.completedDate) {
    content += `\n${currentLang === 'ja' ? 'ÂÆå‰∫ÜÊó•ÊôÇ' : 'Completed'}: ${todo.completedDate}`;
  }

  downloadTextFile(
    todo.text.substring(0, 30).replace(/[^a-zA-Z0-9_\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, '_') + '.txt',
    content
  );
}

async function exportAllTodos() {
  const t = translations[currentLang];
  
  if (todos.length === 0) {
    await customConfirm(t.no_tasks_export, '‚ÑπÔ∏è ' + (currentLang === 'ja' ? 'ÊÉÖÂ†±' : 'Info'), false);
    return;
  }

  const header = currentLang === 'ja' ? '„Çø„Çπ„ÇØ„É™„Çπ„Éà' : 'Task List';
  let content = header + '\n' + '='.repeat(50) + '\n\n';
  
  const active = todos.filter(t => !t.completed);
  const completed = todos.filter(t => t.completed);

  if (active.length > 0) {
    content += `„Äê${currentLang === 'ja' ? 'Êú™ÂÆå‰∫Ü' : 'Active'}„Äë\n`;
    active.forEach((todo, index) => {
      content += `${index + 1}. ‚òê ${todo.text}`;
      if (todo.priority) content += ` [${t['priority_' + todo.priority]}]`;
      if (todo.dueDate) content += ` (${currentLang === 'ja' ? 'ÊúüÈôê' : 'Due'}: ${new Date(todo.dueDate).toLocaleDateString()})`;
      if (todo.tags && todo.tags.length > 0) content += ` #${todo.tags.join(' #')}`;
      content += '\n';
    });
    content += '\n';
  }

  if (completed.length > 0) {
    content += `„Äê${currentLang === 'ja' ? 'ÂÆå‰∫ÜÊ∏à„Åø' : 'Completed'}„Äë\n`;
    completed.forEach((todo, index) => {
      content += `${index + 1}. ‚òë ${todo.text}`;
      if (todo.priority) content += ` [${t['priority_' + todo.priority]}]`;
      if (todo.tags && todo.tags.length > 0) content += ` #${todo.tags.join(' #')}`;
      content += '\n';
    });
  }

  content += '\n' + '='.repeat(50) + '\n';
  const summary = currentLang === 'ja' 
    ? `ÂêàË®à: ${todos.length} | Êú™ÂÆå‰∫Ü: ${active.length} | ÂÆå‰∫ÜÊ∏à„Åø: ${completed.length}\n`
    : `Total: ${todos.length} | Active: ${active.length} | Completed: ${completed.length}\n`;
  content += summary;

  downloadTextFile(`todos_${new Date().toISOString().split('T')[0]}.txt`, content);
}

async function clearCompleted() {
  const t = translations[currentLang];
  const confirmed = await customConfirm(t.confirm_clear_completed, '‚ö†Ô∏è ' + (currentLang === 'ja' ? '‰∏ÄÊã¨ÂâäÈô§Á¢∫Ë™ç' : 'Confirm Clear'));
  
  if (confirmed) {
    todos = todos.filter(t => !t.completed);
    saveTodos();
    renderTodos();
  }
}

function openEditTodoModal(id) {
  editingTodoId = id;
  const todo = todos.find(t => t.id === id);
  if (!todo) return;

  document.getElementById('editTodoText').value = todo.text;
  document.getElementById('editTodoPriority').value = todo.priority || '';
  document.getElementById('editTodoDueDate').value = todo.dueDate || '';
  document.getElementById('editTodoTags').value = todo.tags ? todo.tags.join(', ') : '';
  document.getElementById('editTodoNote').value = todo.note || '';
  document.getElementById('editTodoModal').classList.add('active');
}

function closeEditTodoModal() {
  document.getElementById('editTodoModal').classList.remove('active');
  editingTodoId = null;
}

function saveEditedTodo() {
  if (!editingTodoId) return;

  const todo = todos.find(t => t.id === editingTodoId);
  if (!todo) return;

  todo.text = document.getElementById('editTodoText').value.trim();
  todo.priority = document.getElementById('editTodoPriority').value;
  todo.dueDate = document.getElementById('editTodoDueDate').value;
  todo.note = document.getElementById('editTodoNote').value.trim();
  
  const tagInput = document.getElementById('editTodoTags').value.trim();
  todo.tags = tagInput ? tagInput.split(',').map(t => t.trim()).filter(t => t) : [];

  saveTodos();
  renderTodos();
  closeEditTodoModal();
}

function getDueDateStatus(dueDate) {
  if (!dueDate) return null;
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const due = new Date(dueDate);
  due.setHours(0, 0, 0, 0);
  
  const diffTime = due - today;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays < 0) return { text: translations[currentLang].overdue, class: 'overdue' };
  if (diffDays === 0) return { text: translations[currentLang].due_today, class: 'due-today' };
  if (diffDays === 1) return { text: translations[currentLang].due_tomorrow, class: 'due-tomorrow' };
  return { text: new Date(dueDate).toLocaleDateString(currentLang === 'ja' ? 'ja-JP' : 'en-US'), class: '' };
}

function sortTodos(todosToSort) {
  const sorted = [...todosToSort];
  
  switch (currentTodoSort) {
    case 'oldest':
      return sorted.reverse();
    case 'priority':
      const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2, '': 3 };
      return sorted.sort((a, b) => priorityOrder[a.priority || ''] - priorityOrder[b.priority || '']);
    case 'duedate':
      return sorted.sort((a, b) => {
        if (!a.dueDate && !b.dueDate) return 0;
        if (!a.dueDate) return 1;
        if (!b.dueDate) return -1;
        return new Date(a.dueDate) - new Date(b.dueDate);
      });
    case 'alphabetical':
      return sorted.sort((a, b) => a.text.localeCompare(b.text));
    default:
      return sorted;
  }
}

function renderTodos() {
  let filtered = todos.filter(todo => {
    if (currentFilter === 'active') return !todo.completed;
    if (currentFilter === 'completed') return todo.completed;
    if (currentFilter === 'high') return todo.priority === 'high';
    if (currentFilter === 'medium') return todo.priority === 'medium';
    if (currentFilter === 'low') return todo.priority === 'low';
    if (currentFilter === 'overdue') {
      if (!todo.dueDate || todo.completed) return false;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const due = new Date(todo.dueDate);
      due.setHours(0, 0, 0, 0);
      return due < today;
    }
    return true;
  });

  filtered = sortTodos(filtered);

  const list = document.getElementById('todoList');
  
  if (filtered.length === 0) {
    list.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üì≠</div>
        <div class="empty-state-text">${translations[currentLang].no_tasks}</div>
      </div>
    `;
  } else {
    list.innerHTML = filtered.map(todo => {
      const dueStatus = getDueDateStatus(todo.dueDate);
      
      return `
        <li class="todo-item ${todo.completed ? 'completed' : ''}" data-id="${todo.id}">
          <div class="todo-main-row">
            <div class="checkbox ${todo.completed ? 'checked' : ''}" data-action="toggle" data-id="${todo.id}"></div>
            <div class="todo-text">${todo.text}</div>
            <div class="todo-actions">
              ${todo.priority ? `<span class="priority-badge priority-${todo.priority}">${translations[currentLang]['priority_' + todo.priority]}</span>` : ''}
              ${dueStatus ? `<span class="due-date-badge ${dueStatus.class}">${dueStatus.text}</span>` : ''}
              <button class="action-btn duplicate" data-action="duplicate" data-id="${todo.id}" title="Ë§áË£Ω">üìã</button>
              <button class="action-btn edit" data-action="edit" data-id="${todo.id}" title="Á∑®ÈõÜ">‚úèÔ∏è</button>
              <button class="action-btn export" data-action="export" data-id="${todo.id}" title="„Ç®„ÇØ„Çπ„Éù„Éº„Éà">üíæ</button>
              <button class="action-btn" data-action="delete" data-id="${todo.id}" title="ÂâäÈô§">üóëÔ∏è</button>
            </div>
          </div>
          ${todo.tags && todo.tags.length > 0 ? `
            <div class="todo-meta">
              ${todo.tags.map(tag => `<span class="todo-tag">#${tag}</span>`).join('')}
            </div>
          ` : ''}
          ${todo.note ? `
            <div class="todo-meta">
              <span style="color: #d1d5db;">${todo.note}</span>
            </div>
          ` : ''}
        </li>
      `;
    }).join('');
  }

  updateStats();
  
  if (typeof Sortable !== 'undefined') {
    const list = document.getElementById('todoList');
    
    if (todoSortable) {
      todoSortable.destroy();
    }
    
    todoSortable = Sortable.create(list, {
      animation: 150,
      ghostClass: 'sortable-ghost',
      handle: '.todo-text',
      onEnd: function(evt) {
        const items = Array.from(list.children);
        const newOrder = items.map(item => parseInt(item.dataset.id));
        
        const reordered = [];
        newOrder.forEach(id => {
          const todo = todos.find(t => t.id === id);
          if (todo) reordered.push(todo);
        });
        todos = reordered;
        saveTodos();
      }
    });
  }
}

function updateStats() {
  const total = todos.length;
  const active = todos.filter(t => !t.completed).length;
  const completed = todos.filter(t => t.completed).length;
  const rate = total > 0 ? Math.round((completed / total) * 100) : 0;

  document.getElementById('totalTasks').textContent = total;
  document.getElementById('activeTasks').textContent = active;
  document.getElementById('completedTasks').textContent = completed;
  document.getElementById('completionRate').textContent = rate + '%';
}

function addMemo() {
  const title = document.getElementById('memoTitle').value.trim();
  const content = document.getElementById('memoContent').value.trim();
  
  if (!title && !content) return;

  const tagInput = document.getElementById('memoTags').value.trim();
  const tags = tagInput ? tagInput.split(',').map(t => t.trim()).filter(t => t) : [];

  memos.unshift({
    id: Date.now(),
    title: title || translations[currentLang].untitled,
    content: content,
    date: new Date().toLocaleString(currentLang === 'ja' ? 'ja-JP' : 'en-US'),
    tags: tags
  });

  document.getElementById('memoTitle').value = '';
  document.getElementById('memoContent').value = '';
  document.getElementById('memoTags').value = '';

  saveMemos();
  updateMemoTags();
  renderMemos();
}

async function deleteMemo(id) {
  const t = translations[currentLang];
  const confirmed = await customConfirm(t.confirm_delete_memo, '‚ö†Ô∏è ' + (currentLang === 'ja' ? 'ÂâäÈô§Á¢∫Ë™ç' : 'Confirm Delete'));
  
  if (confirmed) {
    const index = memos.findIndex(memo => memo.id === id);
    if (index !== -1) {
      memos.splice(index, 1);
      saveMemos();
      updateMemoTags();
      renderMemos();
    }
  }
}

function duplicateMemo(id) {
  const memo = memos.find(m => m.id === id);
  if (!memo) return;

  const copyLabel = currentLang === 'ja' ? ' („Ç≥„Éî„Éº)' : ' (Copy)';

  memos.unshift({
    ...memo,
    id: Date.now(),
    title: memo.title + copyLabel,
    date: new Date().toLocaleString(currentLang === 'ja' ? 'ja-JP' : 'en-US')
  });

  saveMemos();
  updateMemoTags();
  renderMemos();
}

function editMemo(id) {
  const memo = memos.find(m => m.id === id);
  if (!memo) return;

  document.getElementById('memoTitle').value = memo.title;
  document.getElementById('memoContent').value = memo.content;
  document.getElementById('memoTags').value = memo.tags ? memo.tags.join(', ') : '';

  const index = memos.findIndex(m => m.id === id);
  if (index !== -1) {
    memos.splice(index, 1);
    saveMemos();
    updateMemoTags();
    renderMemos();
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
  document.getElementById('memoTitle').focus();
}

function exportMemo(id) {
  const memo = memos.find(m => m.id === id);
  if (!memo) return;

  let content = memo.title + '\n' + '='.repeat(memo.title.length) + '\n\n';
  content += memo.content + '\n\n';
  
  if (memo.tags && memo.tags.length > 0) {
    const tagLabel = currentLang === 'ja' ? '„Çø„Ç∞' : 'Tags';
    content += `${tagLabel}: ${memo.tags.join(', ')}\n\n`;
  }
  
  const createdLabel = currentLang === 'ja' ? '‰ΩúÊàêÊó•ÊôÇ' : 'Created';
  content += '---\n' + createdLabel + ': ' + memo.date;

  downloadTextFile(
    memo.title.replace(/[^a-zA-Z0-9_\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, '_') + '.txt',
    content
  );
}

async function exportAllMemos() {
  const t = translations[currentLang];
  
  if (memos.length === 0) {
    await customConfirm(t.no_memos_export, '‚ÑπÔ∏è ' + (currentLang === 'ja' ? 'ÊÉÖÂ†±' : 'Info'), false);
    return;
  }

  const header = currentLang === 'ja' ? '„É°„É¢„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥' : 'Memo Collection';
  let content = header + '\n' + '='.repeat(50) + '\n\n';

  memos.forEach((memo, index) => {
    content += `${index + 1}. ${memo.title}\n`;
    content += '-'.repeat(memo.title.length + 3) + '\n';
    content += memo.content + '\n';
    
    if (memo.tags && memo.tags.length > 0) {
      const tagLabel = currentLang === 'ja' ? '„Çø„Ç∞' : 'Tags';
      content += `${tagLabel}: ${memo.tags.join(', ')}\n`;
    }
    
    const createdLabel = currentLang === 'ja' ? '‰ΩúÊàêÊó•ÊôÇ' : 'Created';
    content += `${createdLabel}: ${memo.date}\n\n`;
    content += '='.repeat(50) + '\n\n';
  });

  downloadTextFile(`all_memos_${new Date().toISOString().split('T')[0]}.txt`, content);
}

function updateMemoTags() {
  const t = translations[currentLang];
  
  allMemoTags.clear();
  memos.forEach(memo => {
    if (memo.tags && memo.tags.length > 0) {
      memo.tags.forEach(tag => allMemoTags.add(tag));
    }
  });

  const filtersDiv = document.getElementById('memoFilters');
  const allButton = `<button class="filter-btn ${currentMemoFilter === 'all' ? 'active' : ''}" onclick="filterMemosByTag('all')">${t.filter_all}</button>`;
  const tagButtons = Array.from(allMemoTags).map(tag => 
    `<button class="filter-btn ${currentMemoFilter === tag ? 'active' : ''}" onclick="filterMemosByTag('${tag}')">#${tag}</button>`
  ).join('');
  
  filtersDiv.innerHTML = allButton + tagButtons;
}

function filterMemosByTag(tag) {
  currentMemoFilter = tag;
  updateMemoTags();
  renderMemos();
}

function sortMemos(memosToSort) {
  const sorted = [...memosToSort];
  
  switch (currentMemoSort) {
    case 'oldest':
      return sorted.reverse();
    case 'alphabetical':
      return sorted.sort((a, b) => a.title.localeCompare(b.title));
    case 'longest':
      return sorted.sort((a, b) => b.content.length - a.content.length);
    default:
      return sorted;
  }
}

function renderMemos() {
  let filtered = memos.filter(memo => {
    if (currentMemoFilter === 'all') return true;
    return memo.tags && memo.tags.includes(currentMemoFilter);
  });

  filtered = sortMemos(filtered);

  const list = document.getElementById('memoList');
  
  if (filtered.length === 0) {
    list.innerHTML = `
      <div class="empty-state" style="grid-column: 1 / -1;">
        <div class="empty-state-icon">üìù</div>
        <div class="empty-state-text">${translations[currentLang].no_memos}</div>
      </div>
    `;
  } else {
    list.innerHTML = filtered.map(memo => `
      <div class="memo-item" data-id="${memo.id}">
        <div class="memo-header">
          <div class="memo-title">${memo.title}</div>
          <div class="memo-actions">
            <button class="action-btn duplicate" data-action="duplicate" data-id="${memo.id}" title="Ë§áË£Ω">üìã</button>
            <button class="action-btn edit" data-action="edit" data-id="${memo.id}" title="Á∑®ÈõÜ">‚úèÔ∏è</button>
            <button class="action-btn export" data-action="export" data-id="${memo.id}" title="„Ç®„ÇØ„Çπ„Éù„Éº„Éà">üíæ</button>
            <button class="action-btn" data-action="delete" data-id="${memo.id}" title="ÂâäÈô§">üóëÔ∏è</button>
          </div>
        </div>
        <div class="memo-content-preview">${typeof marked !== 'undefined' ? marked.parse(memo.content.substring(0, 200) + (memo.content.length > 200 ? '...' : '')) : memo.content.substring(0, 200) + (memo.content.length > 200 ? '...' : '')}</div>
        ${memo.tags && memo.tags.length > 0 ? `
          <div class="memo-tags-display">
            ${memo.tags.map(tag => `<span class="memo-tag-item">#${tag}</span>`).join('')}
          </div>
        ` : ''}
        <div class="memo-date">${memo.date}</div>
      </div>
    `).join('');
  }
}

function insertText(text) {
  const textarea = document.getElementById('memoContent');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const selectedText = textarea.value.substring(start, end);
  const content = textarea.value;

  let insertedText = '';
  let cursorOffset = 0;

  if (text === '**Â§™Â≠ó**' || text === '*Êñú‰Ωì*' || text === '~~Êâì„Å°Ê∂à„ÅóÁ∑ö~~') {
    if (selectedText) {
      let marker;
      if (text === '**Â§™Â≠ó**') marker = '**';
      else if (text === '*Êñú‰Ωì*') marker = '*';
      else marker = '~~';
      
      insertedText = marker + selectedText + marker;
      cursorOffset = insertedText.length;
    } else {
      insertedText = text;
      if (text === '**Â§™Â≠ó**') cursorOffset = 2;
      else if (text === '*Êñú‰Ωì*') cursorOffset = 1;
      else cursorOffset = 2;
    }
  }
  else if (text.includes('```')) {
    if (selectedText) {
      insertedText = '```\n' + selectedText + '\n```';
      cursorOffset = insertedText.length;
    } else {
      insertedText = '```\n\n```';
      cursorOffset = 4;
    }
  }
  else {
    insertedText = text;
    cursorOffset = text.length;
  }

  textarea.value = content.substring(0, start) + insertedText + content.substring(end);
  textarea.focus();
  textarea.selectionStart = textarea.selectionEnd = start + cursorOffset;
}

function insertLink() {
  const textarea = document.getElementById('memoContent');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const selectedText = textarea.value.substring(start, end);
  const content = textarea.value;

  let insertedText;
  let cursorOffset;

  if (selectedText) {
    insertedText = `[${selectedText}](URL)`;
    cursorOffset = insertedText.length - 4;
  } else {
    insertedText = '[„É™„É≥„ÇØ„ÉÜ„Ç≠„Çπ„Éà](URL)';
    cursorOffset = 1;
  }

  textarea.value = content.substring(0, start) + insertedText + content.substring(end);
  textarea.focus();
  textarea.selectionStart = start + cursorOffset;
  textarea.selectionEnd = start + cursorOffset + (selectedText ? 3 : 11);
}

function insertImage() {
  const textarea = document.getElementById('memoContent');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const content = textarea.value;

  const insertedText = '![ÁîªÂÉè„ÅÆË™¨Êòé](ÁîªÂÉè„ÅÆURL)';
  
  textarea.value = content.substring(0, start) + insertedText + content.substring(end);
  textarea.focus();
  textarea.selectionStart = start + 2;
  textarea.selectionEnd = start + 8;
}

function insertTable() {
  const textarea = document.getElementById('memoContent');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const content = textarea.value;

  const tableText = `| Âàó1 | Âàó2 | Âàó3 |
| --- | --- | --- |
| „Éá„Éº„Çø1 | „Éá„Éº„Çø2 | „Éá„Éº„Çø3 |
| „Éá„Éº„Çø4 | „Éá„Éº„Çø5 | „Éá„Éº„Çø6 |`;
  
  textarea.value = content.substring(0, start) + tableText + content.substring(end);
  textarea.focus();
  textarea.selectionStart = textarea.selectionEnd = start + tableText.length;
}

function insertHorizontalRule() {
  const textarea = document.getElementById('memoContent');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const content = textarea.value;

  const hrText = '\n---\n';
  
  textarea.value = content.substring(0, start) + hrText + content.substring(end);
  textarea.focus();
  textarea.selectionStart = textarea.selectionEnd = start + hrText.length;
}

function downloadTextFile(filename, content) {
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(link.href);
}

function openSearch() {
  document.getElementById('searchModal').classList.add('active');
  document.getElementById('searchInput').focus();
}

function closeSearch() {
  document.getElementById('searchModal').classList.remove('active');
  document.getElementById('searchInput').value = '';
  document.getElementById('searchResults').innerHTML = '';
}

function jumpTo(type, id) {
  closeSearch();
  
  const modeButtons = document.querySelectorAll('.mode-btn');
  const todoContainer = document.querySelector('.todo-container');
  const memoContainer = document.querySelector('.memo-container');

  modeButtons.forEach(btn => btn.classList.remove('active'));

  if (type === 'todo') {
    document.querySelector('[data-mode="todo"]').classList.add('active');
    todoContainer.classList.add('active');
    memoContainer.classList.remove('active');

    setTimeout(() => {
      const element = document.querySelector(`[data-id="${id}"]`);
      if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        element.style.boxShadow = '0 0 30px rgba(103, 6, 118, 0.8)';
        setTimeout(() => element.style.boxShadow = '', 2000);
      }
    }, 100);
  } else {
    document.querySelector('[data-mode="memo"]').classList.add('active');
    todoContainer.classList.remove('active');
    memoContainer.classList.add('active');
  }
}

function showStats() {
  const modal = document.getElementById('statsModal');
  const content = document.getElementById('statsContent');
  const t = translations[currentLang];
  
  const totalTodos = todos.length;
  const activeTodos = todos.filter(t => !t.completed).length;
  const completedTodos = todos.filter(t => t.completed).length;
  const highPriority = todos.filter(t => t.priority === 'high').length;
  const mediumPriority = todos.filter(t => t.priority === 'medium').length;
  const lowPriority = todos.filter(t => t.priority === 'low').length;
  const totalMemos = memos.length;
  const totalTags = allMemoTags.size;
  
  content.innerHTML = `
    <div class="stats">
      <div class="stat-item">
        <div class="stat-value">${totalTodos}</div>
        <div class="stat-label">${t.total_tasks}</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${activeTodos}</div>
        <div class="stat-label">${t.active_tasks}</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${completedTodos}</div>
        <div class="stat-label">${t.completed_tasks}</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${highPriority}</div>
        <div class="stat-label">${t.high_priority_tasks}</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${totalMemos}</div>
        <div class="stat-label">${t.total_memos}</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${totalTags}</div>
        <div class="stat-label">${t.tags_in_use}</div>
      </div>
    </div>
    
    <div class="chart-container" style="margin-top: 2rem;">
      <canvas id="statsChart"></canvas>
    </div>
    
    <div class="chart-container">
      <canvas id="priorityChart"></canvas>
    </div>
  `;
  
  modal.classList.add('active');
  
  setTimeout(() => {
    if (typeof Chart !== 'undefined') {
      const ctx1 = document.getElementById('statsChart');
      if (ctx1) {
        new Chart(ctx1, {
          type: 'doughnut',
          data: {
            labels: [t.active_tasks || 'Êú™ÂÆå‰∫Ü', t.completed_tasks || 'ÂÆå‰∫ÜÊ∏à„Åø'],
            datasets: [{
              data: [activeTodos, completedTodos],
              backgroundColor: ['#a855f7', '#10b981'],
              borderColor: ['#670676', '#059669'],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                labels: { color: '#fff' },
                position: 'bottom'
              },
              title: {
                display: true,
                text: currentLang === 'ja' ? '„Çø„Çπ„ÇØÂÆå‰∫ÜÁä∂Ê≥Å' : 'Task Completion Status',
                color: '#a855f7',
                font: { size: 16, weight: 'bold' }
              }
            }
          }
        });
      }
      
      const ctx2 = document.getElementById('priorityChart');
      if (ctx2) {
        new Chart(ctx2, {
          type: 'bar',
          data: {
            labels: [t.priority_high || 'È´ò', t.priority_medium || '‰∏≠', t.priority_low || '‰Ωé'],
            datasets: [{
              label: currentLang === 'ja' ? '„Çø„Çπ„ÇØÊï∞' : 'Tasks',
              data: [highPriority, mediumPriority, lowPriority],
              backgroundColor: ['#ef4444', '#fbbf24', '#10b981'],
              borderColor: ['#dc2626', '#f59e0b', '#059669'],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                labels: { color: '#fff' }
              },
              title: {
                display: true,
                text: currentLang === 'ja' ? 'ÂÑ™ÂÖàÂ∫¶Âà•„Çø„Çπ„ÇØÊï∞' : 'Tasks by Priority',
                color: '#a855f7',
                font: { size: 16, weight: 'bold' }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { color: '#fff' },
                grid: { color: 'rgba(103, 6, 118, 0.2)' }
              },
              x: {
                ticks: { color: '#fff' },
                grid: { color: 'rgba(103, 6, 118, 0.2)' }
              }
            }
          }
        });
      }
    }
  }, 100);
}

function closeStats() {
  document.getElementById('statsModal').classList.remove('active');
}

function openSettings() {
  document.getElementById('settingsModal').classList.add('active');
}

function closeSettings() {
  document.getElementById('settingsModal').classList.remove('active');
}

function showKeyboardShortcuts() {
  document.getElementById('shortcutsModal').classList.add('active');
}

function closeKeyboardShortcuts() {
  document.getElementById('shortcutsModal').classList.remove('active');
}

function exportAllData() {
  const data = {
    todos: todos,
    memos: memos,
    user: currentUser ? currentUser.username : 'unknown',
    exportDate: new Date().toISOString()
  };
  
  const json = JSON.stringify(data, null, 2);
  downloadTextFile(`todo-memo-backup-${new Date().toISOString().split('T')[0]}.json`, json);
}

function importData() {
  const t = translations[currentLang];
  
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async (event) => {
      try {
        const data = JSON.parse(event.target.result);
        
        const confirmed = await customConfirm(t.confirm_import, '‚ö†Ô∏è ' + (currentLang === 'ja' ? '„Ç§„É≥„Éù„Éº„ÉàÁ¢∫Ë™ç' : 'Confirm Import'));
        
        if (confirmed) {
          if (data.todos) todos = data.todos;
          if (data.memos) memos = data.memos;
          
          saveTodos();
          saveMemos();
          updateMemoTags();
          renderTodos();
          renderMemos();
          
          await customConfirm(t.import_success, '‚úÖ ' + (currentLang === 'ja' ? 'ÊàêÂäü' : 'Success'), false);
          closeSettings();
        }
      } catch (error) {
        await customConfirm(t.import_error, '‚ùå ' + (currentLang === 'ja' ? '„Ç®„É©„Éº' : 'Error'), false);
      }
    };
    
    reader.readAsText(file);
  };
  
  input.click();
}

async function clearAllData() {
  const t = translations[currentLang];
  
  const confirmed1 = await customConfirm(t.confirm_clear_all_1, '‚ö†Ô∏è ' + (currentLang === 'ja' ? 'ÂÖ®„Éá„Éº„ÇøÂâäÈô§' : 'Clear All Data'));
  
  if (confirmed1) {
    const confirmed2 = await customConfirm(t.confirm_clear_all_2, '‚ö†Ô∏è‚ö†Ô∏è ' + (currentLang === 'ja' ? 'ÊúÄÁµÇÁ¢∫Ë™ç' : 'Final Confirmation'));
    
    if (confirmed2) {
      todos = [];
      memos = [];
      saveTodos();
      saveMemos();
      updateMemoTags();
      renderTodos();
      renderMemos();
      closeSettings();
    }
  }
}

document.getElementById('searchInput').addEventListener('input', function(e) {
  const query = e.target.value.toLowerCase().trim();
  const resultsDiv = document.getElementById('searchResults');
  const t = translations[currentLang];

  if (!query) {
    resultsDiv.innerHTML = '';
    return;
  }

  const results = [];

  todos.forEach(todo => {
    if (todo.text.toLowerCase().includes(query) ||
        (todo.tags && todo.tags.some(tag => tag.toLowerCase().includes(query))) ||
        (todo.note && todo.note.toLowerCase().includes(query))) {
      results.push({
        type: 'todo',
        id: todo.id,
        title: todo.text,
        preview: todo.completed ? '‚úì ' + t.completed : t.active
      });
    }
  });

  memos.forEach(memo => {
    if (memo.title.toLowerCase().includes(query) ||
        memo.content.toLowerCase().includes(query) ||
        (memo.tags && memo.tags.some(tag => tag.toLowerCase().includes(query)))) {
      results.push({
        type: 'memo',
        id: memo.id,
        title: memo.title,
        preview: memo.content.substring(0, 100) + '...'
      });
    }
  });

  if (results.length === 0) {
    resultsDiv.innerHTML = `<p style="color: #9ca3af; text-align: center;">${t.no_results}</p>`;
    return;
  }

  resultsDiv.innerHTML = results.map(result => `
    <div class="search-result-item" onclick="jumpTo('${result.type}', ${result.id})">
      <div class="search-result-title">${result.type === 'todo' ? 'üìù' : 'üìÑ'} ${result.title}</div>
      <div class="search-result-preview">${result.preview}</div>
    </div>
  `).join('');
});

document.getElementById('addTodoBtn').addEventListener('click', addTodo);
document.getElementById('todoInput').addEventListener('keypress', e => {
  if (e.key === 'Enter') addTodo();
});

document.getElementById('todoList').addEventListener('click', function(e) {
  const target = e.target;
  const action = target.dataset.action;
  const id = parseInt(target.dataset.id);
  
  if (!action || !id) return;
  
  e.stopPropagation();
  
  switch(action) {
    case 'toggle':
      toggleTodo(id);
      break;
    case 'delete':
      deleteTodo(id);
      break;
    case 'duplicate':
      duplicateTodo(id);
      break;
    case 'edit':
      openEditTodoModal(id);
      break;
    case 'export':
      exportTodo(id);
      break;
  }
});

document.querySelectorAll('.filter-tabs .filter-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.filter-tabs .filter-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    currentFilter = this.dataset.filter;
    renderTodos();
  });
});

document.getElementById('todoSort').addEventListener('change', function() {
  currentTodoSort = this.value;
  renderTodos();
});

document.getElementById('addMemoBtn').addEventListener('click', addMemo);

document.getElementById('memoList').addEventListener('click', function(e) {
  const target = e.target;
  const action = target.dataset.action;
  const id = parseInt(target.dataset.id);
  
  if (!action || !id) return;
  
  e.stopPropagation();
  
  switch(action) {
    case 'delete':
      deleteMemo(id);
      break;
    case 'duplicate':
      duplicateMemo(id);
      break;
    case 'edit':
      editMemo(id);
      break;
    case 'export':
      exportMemo(id);
      break;
  }
});

document.getElementById('memoTitle').addEventListener('keypress', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('memoContent').focus();
  }
});

document.getElementById('memoContent').addEventListener('keypress', e => {
  if (e.key === 'Enter' && e.ctrlKey) {
    addMemo();
  }
});

document.getElementById('memoSort').addEventListener('change', function() {
  currentMemoSort = this.value;
  renderMemos();
});

document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');

    const mode = this.dataset.mode;
    if (mode === 'todo') {
      document.querySelector('.todo-container').classList.add('active');
      document.querySelector('.memo-container').classList.remove('active');
    } else {
      document.querySelector('.todo-container').classList.remove('active');
      document.querySelector('.memo-container').classList.add('active');
    }
  });
});

document.getElementById('langSwitcher').addEventListener('click', () => {
  currentLang = currentLang === 'ja' ? 'en' : 'ja';
  document.getElementById('langSwitcher').textContent = currentLang === 'ja' ? 'EN' : 'JA';
  updateUILanguage();
  renderTodos();
  renderMemos();
});

document.addEventListener('keydown', e => {
  if (document.activeElement.id === 'memoContent') {
    if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
      e.preventDefault();
      insertText('**Â§™Â≠ó**');
      return;
    }
    if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
      e.preventDefault();
      insertText('*Êñú‰Ωì*');
      return;
    }
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      insertLink();
      return;
    }
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'K') {
      e.preventDefault();
      insertText('```\n\n```');
      return;
    }
  }
  
  if ((e.ctrlKey || e.metaKey) && e.key === 'k' && document.activeElement.id !== 'memoContent') {
    e.preventDefault();
    openSearch();
    return;
  }
  
  if (e.key === 'Escape') {
    closeSearch();
    closeEditTodoModal();
    closeStats();
    closeSettings();
    closeKeyboardShortcuts();
  }
});

(function() {
  try {
    const storedUser = sessionStorage.getItem('currentUser');
    if (storedUser) {
      const user = JSON.parse(storedUser);
      loginUser(user);
    }
  } catch (e) {
    console.error('„Çª„ÉÉ„Ç∑„Éß„É≥Âæ©ÂÖÉ„Ç®„É©„Éº:', e);
  }
})();
</script>
</body>
</html>