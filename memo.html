<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Todo & Memo</title>

<!-- External Libraries -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  background: #0a0a0a;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
  background-attachment: fixed;
  color: #fff;
  min-height: 100vh;
}

header {
  background: rgba(0, 0, 0, 0.9);
  border-bottom: 2px solid rgba(103, 6, 118, 0.4);
  padding: 1.5rem 2rem;
  backdrop-filter: blur(10px);
  position: sticky;
  top: 0;
  z-index: 100;
}

nav {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
}

.logo {
  font-size: 1.75rem;
  font-weight: bold;
  background: linear-gradient(135deg, #a855f7, #ec4899);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.header-actions {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.header-btn {
  background: rgba(103, 6, 118, 0.2);
  border: 1px solid rgba(103, 6, 118, 0.3);
  color: #a855f7;
  padding: 0.6rem 1.2rem;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  font-size: 0.9rem;
}

.header-btn:hover {
  background: rgba(103, 6, 118, 0.4);
  border-color: #670676;
  transform: translateY(-2px);
}

main {
  padding: 3rem 1.5rem;
}

.mode-switcher {
  max-width: 1200px;
  margin: 0 auto 2rem;
  display: flex;
  gap: 1rem;
  justify-content: center;
  flex-wrap: wrap;
}

.mode-btn {
  background: rgba(103, 6, 118, 0.2);
  border: 2px solid rgba(103, 6, 118, 0.3);
  border-radius: 12px;
  padding: 1rem 2rem;
  color: #9ca3af;
  font-size: 1.1rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
}

.mode-btn:hover {
  border-color: #670676;
  transform: translateY(-2px);
}

.mode-btn.active {
  background: linear-gradient(135deg, #670676, #8800aa);
  border-color: #670676;
  color: #fff;
  box-shadow: 0 8px 20px rgba(103, 6, 118, 0.4);
}

.content-area {
  max-width: 1200px;
  margin: 0 auto;
}

.todo-container, .memo-container {
  background: linear-gradient(135deg, rgba(17, 17, 17, 0.95), rgba(0, 0, 0, 0.95));
  border: 2px solid rgba(103, 6, 118, 0.3);
  border-radius: 16px;
  padding: 2.5rem;
  display: none;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
}

.todo-container.active, .memo-container.active {
  display: block;
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

h1 {
  font-size: 2.5rem;
  margin-bottom: 2rem;
  text-align: center;
  background: linear-gradient(135deg, #a855f7, #ec4899);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.input-section {
  display: flex;
  gap: 0.75rem;
  margin-bottom: 2rem;
  flex-wrap: wrap;
}

#todoInput, #memoTitle, #memoContent, #memoTags {
  width: 100%;
  background: rgba(103, 6, 118, 0.1);
  border: 2px solid rgba(103, 6, 118, 0.3);
  border-radius: 8px;
  padding: 0.875rem 1.25rem;
  color: #fff;
  font-size: 1rem;
  transition: all 0.3s;
}

#memoContent {
  min-height: 200px;
  resize: vertical;
  font-family: 'Monaco', 'Courier New', monospace;
  line-height: 1.6;
}

input:focus, textarea:focus {
  outline: none;
  border-color: #670676;
  box-shadow: 0 0 20px rgba(103, 6, 118, 0.3);
}

input::placeholder, textarea::placeholder {
  color: #6b7280;
}

.btn-primary {
  background: linear-gradient(135deg, #670676, #8800aa);
  border: none;
  border-radius: 8px;
  padding: 0.875rem 2rem;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(103, 6, 118, 0.3);
}

.btn-primary:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 20px rgba(103, 6, 118, 0.5);
}

.btn-success {
  background: linear-gradient(135deg, #10b981, #059669);
  border: none;
  border-radius: 8px;
  padding: 0.875rem 2rem;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-success:hover {
  transform: scale(1.05);
}

.filter-tabs, .memo-filters {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}

.filter-btn {
  background: transparent;
  border: 1px solid rgba(103, 6, 118, 0.3);
  color: #9ca3af;
  padding: 0.5rem 1rem;
  cursor: pointer;
  font-weight: 600;
  border-radius: 6px;
  transition: all 0.3s;
}

.filter-btn:hover {
  border-color: #670676;
}

.filter-btn.active {
  background: rgba(103, 6, 118, 0.3);
  color: #a855f7;
  border-color: #670676;
}

.todo-list {
  list-style: none;
  max-height: 500px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: #670676 rgba(103, 6, 118, 0.2);
}

.todo-list::-webkit-scrollbar {
  width: 8px;
}

.todo-list::-webkit-scrollbar-track {
  background: rgba(103, 6, 118, 0.2);
  border-radius: 10px;
}

.todo-list::-webkit-scrollbar-thumb {
  background: #670676;
  border-radius: 10px;
}

.todo-item {
  background: rgba(103, 6, 118, 0.1);
  border: 1px solid rgba(103, 6, 118, 0.2);
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 0.75rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  transition: all 0.3s;
}

.todo-item:hover {
  border-color: #670676;
  transform: translateX(4px);
}

.todo-main-row {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.checkbox {
  width: 24px;
  height: 24px;
  min-width: 24px;
  border: 2px solid #670676;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
}

.checkbox:hover {
  background: rgba(103, 6, 118, 0.2);
}

.checkbox.checked {
  background: #670676;
}

.checkbox.checked::after {
  content: 'âœ“';
  color: #fff;
  font-weight: bold;
}

.todo-text {
  flex: 1;
  font-size: 1rem;
  word-break: break-word;
}

.todo-item.completed .todo-text {
  text-decoration: line-through;
  color: #6b7280;
}

.todo-actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.priority-badge {
  padding: 0.25rem 0.6rem;
  border-radius: 4px;
  font-size: 0.7rem;
  font-weight: bold;
  white-space: nowrap;
}

.priority-high {
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
  border: 1px solid rgba(239, 68, 68, 0.3);
}

.priority-medium {
  background: rgba(251, 191, 36, 0.2);
  color: #fbbf24;
  border: 1px solid rgba(251, 191, 36, 0.3);
}

.priority-low {
  background: rgba(16, 185, 129, 0.2);
  color: #10b981;
  border: 1px solid rgba(16, 185, 129, 0.3);
}

.due-date-badge {
  padding: 0.25rem 0.6rem;
  border-radius: 4px;
  font-size: 0.7rem;
  font-weight: bold;
  background: rgba(59, 130, 246, 0.2);
  color: #3b82f6;
  border: 1px solid rgba(59, 130, 246, 0.3);
  white-space: nowrap;
}

.due-date-badge.overdue {
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
  border-color: rgba(239, 68, 68, 0.3);
}

.todo-meta {
  display: flex;
  gap: 1rem;
  font-size: 0.8rem;
  color: #9ca3af;
  padding-left: 2.5rem;
  flex-wrap: wrap;
}

.todo-tag {
  background: rgba(103, 6, 118, 0.2);
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  border: 1px solid rgba(103, 6, 118, 0.3);
}

.action-btn {
  background: rgba(220, 38, 38, 0.2);
  border: 1px solid rgba(220, 38, 38, 0.3);
  border-radius: 6px;
  padding: 0.4rem 0.7rem;
  color: #ef4444;
  cursor: pointer;
  font-size: 0.75rem;
  transition: all 0.3s;
  white-space: nowrap;
}

.action-btn:hover {
  background: rgba(220, 38, 38, 0.3);
  transform: scale(1.05);
}

.action-btn.export {
  background: rgba(16, 185, 129, 0.2);
  border-color: rgba(16, 185, 129, 0.3);
  color: #10b981;
}

.action-btn.export:hover {
  background: rgba(16, 185, 129, 0.3);
}

.action-btn.edit {
  background: rgba(59, 130, 246, 0.2);
  border-color: rgba(59, 130, 246, 0.3);
  color: #3b82f6;
}

.action-btn.edit:hover {
  background: rgba(59, 130, 246, 0.3);
}

.action-btn.duplicate {
  background: rgba(168, 85, 247, 0.2);
  border-color: rgba(168, 85, 247, 0.3);
  color: #a855f7;
}

.action-btn.duplicate:hover {
  background: rgba(168, 85, 247, 0.3);
}

.export-section {
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid rgba(103, 6, 118, 0.3);
  display: flex;
  gap: 1rem;
  justify-content: center;
  flex-wrap: wrap;
}

.stats {
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid rgba(103, 6, 118, 0.3);
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1.5rem;
  text-align: center;
}

.stat-item {
  background: rgba(103, 6, 118, 0.1);
  border: 1px solid rgba(103, 6, 118, 0.2);
  border-radius: 12px;
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  transition: all 0.3s;
}

.stat-item:hover {
  border-color: #670676;
  transform: translateY(-4px);
}

.stat-value {
  font-size: 2rem;
  font-weight: bold;
  background: linear-gradient(135deg, #a855f7, #ec4899);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.stat-label {
  font-size: 0.875rem;
  color: #9ca3af;
}

.memo-toolbar {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  flex-wrap: wrap;
}

.toolbar-btn {
  background: rgba(103, 6, 118, 0.2);
  border: 1px solid rgba(103, 6, 118, 0.3);
  color: #a855f7;
  padding: 0.5rem 0.75rem;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  font-size: 0.85rem;
  white-space: nowrap;
}

.toolbar-btn:hover {
  background: rgba(103, 6, 118, 0.4);
  border-color: #670676;
  transform: translateY(-2px);
}

.memo-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1rem;
  max-height: 600px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: #670676 rgba(103, 6, 118, 0.2);
}

.memo-list::-webkit-scrollbar {
  width: 8px;
}

.memo-list::-webkit-scrollbar-track {
  background: rgba(103, 6, 118, 0.2);
  border-radius: 10px;
}

.memo-list::-webkit-scrollbar-thumb {
  background: #670676;
  border-radius: 10px;
}

.memo-item {
  background: rgba(103, 6, 118, 0.15);
  border: 1px solid rgba(103, 6, 118, 0.3);
  border-radius: 12px;
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  transition: all 0.3s;
}

.memo-item:hover {
  border-color: #670676;
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(103, 6, 118, 0.3);
}

.memo-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 1rem;
}

.memo-title {
  font-size: 1.25rem;
  font-weight: bold;
  color: #a855f7;
  flex: 1;
  word-break: break-word;
}

.memo-actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.memo-content {
  color: #d1d5db;
  line-height: 1.6;
  white-space: pre-wrap;
  word-break: break-word;
}

.memo-preview {
  background: rgba(103, 6, 118, 0.05);
  border: 2px solid rgba(103, 6, 118, 0.3);
  border-radius: 8px;
  padding: 1.5rem;
  margin-bottom: 1rem;
  min-height: 200px;
  max-height: 400px;
  overflow-y: auto;
  display: none;
}

.memo-preview.active {
  display: block;
}

.memo-preview h1, .memo-preview h2, .memo-preview h3 {
  color: #a855f7;
  margin-top: 1rem;
  margin-bottom: 0.5rem;
}

.memo-preview h1 { font-size: 2rem; }
.memo-preview h2 { font-size: 1.5rem; }
.memo-preview h3 { font-size: 1.25rem; }

.memo-preview p { margin-bottom: 1rem; }

.memo-preview code {
  background: rgba(103, 6, 118, 0.3);
  padding: 0.2rem 0.4rem;
  border-radius: 4px;
  color: #ec4899;
  font-family: 'Courier New', monospace;
}

.memo-preview pre {
  background: rgba(0, 0, 0, 0.5);
  padding: 1rem;
  border-radius: 8px;
  overflow-x: auto;
  border: 1px solid rgba(103, 6, 118, 0.3);
  margin: 1rem 0;
}

.memo-preview pre code {
  background: none;
  padding: 0;
  color: #a855f7;
}

.memo-preview blockquote {
  border-left: 4px solid #670676;
  padding-left: 1rem;
  margin: 1rem 0;
  color: #9ca3af;
  font-style: italic;
}

.memo-preview ul, .memo-preview ol {
  margin-left: 1.5rem;
  margin-bottom: 1rem;
}

.memo-preview li { margin-bottom: 0.5rem; }

.memo-preview table {
  width: 100%;
  border-collapse: collapse;
  margin: 1rem 0;
}

.memo-preview table th, .memo-preview table td {
  border: 1px solid rgba(103, 6, 118, 0.3);
  padding: 0.75rem;
  text-align: left;
}

.memo-preview table th {
  background: rgba(103, 6, 118, 0.2);
  color: #a855f7;
  font-weight: bold;
}

.memo-preview img {
  max-width: 100%;
  border-radius: 8px;
  margin: 1rem 0;
}

.memo-preview a {
  color: #3b82f6;
  text-decoration: underline;
}

.memo-preview a:hover { color: #60a5fa; }

.memo-preview hr {
  border: none;
  border-top: 2px solid rgba(103, 6, 118, 0.3);
  margin: 1.5rem 0;
}

.view-toggle {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.view-btn {
  background: rgba(103, 6, 118, 0.2);
  border: 1px solid rgba(103, 6, 118, 0.3);
  color: #a855f7;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  font-size: 0.9rem;
}

.view-btn:hover {
  background: rgba(103, 6, 118, 0.4);
  border-color: #670676;
}

.view-btn.active {
  background: rgba(103, 6, 118, 0.4);
  border-color: #670676;
  box-shadow: 0 4px 10px rgba(103, 6, 118, 0.3);
}

.chart-container {
  background: rgba(103, 6, 118, 0.1);
  border: 1px solid rgba(103, 6, 118, 0.2);
  border-radius: 12px;
  padding: 1.5rem;
  margin: 1rem 0;
}

.memo-tags-display {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.memo-tag-item {
  background: rgba(103, 6, 118, 0.3);
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  color: #a855f7;
  border: 1px solid rgba(103, 6, 118, 0.4);
}

.memo-date {
  font-size: 0.75rem;
  color: #6b7280;
  text-align: right;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 2rem;
  backdrop-filter: blur(5px);
}

.modal.active {
  display: flex;
  animation: fadeIn 0.3s ease-in-out;
}

.modal-content {
  background: linear-gradient(135deg, rgba(17, 17, 17, 0.98), rgba(0, 0, 0, 0.98));
  border: 2px solid #670676;
  border-radius: 16px;
  padding: 2rem;
  max-width: 600px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
  box-shadow: 0 20px 60px rgba(103, 6, 118, 0.5);
}

.modal-title {
  font-size: 1.5rem;
  margin-bottom: 1.5rem;
  color: #a855f7;
}

.modal-input, .modal-select, .modal-textarea {
  width: 100%;
  background: rgba(103, 6, 118, 0.1);
  border: 2px solid rgba(103, 6, 118, 0.3);
  border-radius: 8px;
  padding: 0.875rem;
  color: #fff;
  margin-bottom: 1rem;
  transition: all 0.3s;
}

.modal-textarea {
  min-height: 100px;
  resize: vertical;
  font-family: inherit;
}

.modal-input:focus, .modal-select:focus, .modal-textarea:focus {
  outline: none;
  border-color: #670676;
  box-shadow: 0 0 20px rgba(103, 6, 118, 0.3);
}

.modal-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
  flex-wrap: wrap;
}

.modal-btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
}

.modal-btn-primary {
  background: linear-gradient(135deg, #670676, #8800aa);
  color: #fff;
}

.modal-btn-primary:hover { transform: scale(1.05); }

.modal-btn-secondary {
  background: rgba(103, 6, 118, 0.2);
  color: #a855f7;
  border: 1px solid rgba(103, 6, 118, 0.3);
}

.modal-btn-secondary:hover { background: rgba(103, 6, 118, 0.4); }

.close-modal {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: rgba(220, 38, 38, 0.2);
  border: none;
  color: #ef4444;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s;
}

.close-modal:hover { background: rgba(220, 38, 38, 0.4); }

.confirm-dialog {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  z-index: 2000;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(5px);
}

.confirm-dialog.active {
  display: flex;
  animation: fadeIn 0.2s ease-in-out;
}

.confirm-dialog-content {
  background: linear-gradient(135deg, rgba(17, 17, 17, 0.98), rgba(0, 0, 0, 0.98));
  border: 2px solid #670676;
  border-radius: 16px;
  padding: 2rem;
  max-width: 450px;
  width: 90%;
  box-shadow: 0 20px 60px rgba(103, 6, 118, 0.5);
}

.confirm-dialog-title {
  font-size: 1.25rem;
  margin-bottom: 1rem;
  color: #a855f7;
  font-weight: bold;
}

.confirm-dialog-message {
  color: #d1d5db;
  margin-bottom: 1.5rem;
  line-height: 1.6;
}

.confirm-dialog-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
}

.confirm-btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
}

.confirm-btn-danger {
  background: linear-gradient(135deg, #dc2626, #991b1b);
  color: #fff;
}

.confirm-btn-danger:hover { transform: scale(1.05); }

.confirm-btn-cancel {
  background: rgba(103, 6, 118, 0.2);
  color: #a855f7;
  border: 1px solid rgba(103, 6, 118, 0.3);
}

.confirm-btn-cancel:hover { background: rgba(103, 6, 118, 0.4); }

.shortcuts-list {
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

.shortcut-section h3 {
  color: #a855f7;
  font-size: 1.1rem;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid rgba(103, 6, 118, 0.3);
}

.shortcut-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem;
  background: rgba(103, 6, 118, 0.1);
  border-radius: 8px;
  margin-bottom: 0.5rem;
}

.shortcut-item kbd {
  background: rgba(103, 6, 118, 0.3);
  border: 1px solid rgba(103, 6, 118, 0.5);
  border-radius: 4px;
  padding: 0.25rem 0.5rem;
  font-family: 'Courier New', monospace;
  font-size: 0.85rem;
  color: #a855f7;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.shortcut-item span { color: #d1d5db; }

.search-results {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-top: 1rem;
}

.search-result-item {
  background: rgba(103, 6, 118, 0.1);
  border: 1px solid rgba(103, 6, 118, 0.3);
  border-radius: 8px;
  padding: 1rem;
  cursor: pointer;
  transition: all 0.3s;
}

.search-result-item:hover {
  border-color: #670676;
  transform: translateX(4px);
}

.search-result-title {
  font-weight: bold;
  color: #a855f7;
  margin-bottom: 0.5rem;
}

.search-result-preview {
  color: #9ca3af;
  font-size: 0.9rem;
}

.sort-controls {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
  align-items: center;
}

.sort-label {
  color: #9ca3af;
  font-size: 0.9rem;
  font-weight: 600;
}

.sort-select {
  background: rgba(103, 6, 118, 0.2);
  border: 1px solid rgba(103, 6, 118, 0.3);
  color: #a855f7;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
}

.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  color: #6b7280;
}

.empty-state-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.empty-state-text { font-size: 1.2rem; }

@media (max-width: 768px) {
  .mode-switcher, .input-section, .export-section {
    flex-direction: column;
  }
  .memo-list { grid-template-columns: 1fr; }
  .stats { grid-template-columns: 1fr; }
  h1 { font-size: 2rem; }
  .todo-main-row { flex-wrap: wrap; }
  .todo-actions { width: 100%; padding-left: 2.5rem; }
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.todo-item, .memo-item { animation: slideIn 0.3s ease-out; }

.memo-content-preview {
  color: #d1d5db;
  line-height: 1.6;
  word-break: break-word;
}

::-webkit-scrollbar { width: 10px; }
::-webkit-scrollbar-track { background: rgba(103, 6, 118, 0.1); }
::-webkit-scrollbar-thumb { background: #670676; border-radius: 5px; }
::-webkit-scrollbar-thumb:hover { background: #8800aa; }
</style>
</head>
<body>

<header>
  <nav>
    <div class="logo">ğŸ“ Todo & Memo</div>
    <div class="header-actions">
      <button class="header-btn" onclick="openSearch()">ğŸ” æ¤œç´¢</button>
      <button class="header-btn" onclick="showStats()">ğŸ“Š çµ±è¨ˆ</button>
      <button class="header-btn" onclick="showKeyboardShortcuts()">âŒ¨ï¸ ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</button>
      <button class="header-btn" onclick="openSettings()">âš™ï¸ è¨­å®š</button>
      <button class="header-btn" id="langSwitcher">EN</button>
    </div>
  </nav>
</header>

<main>
  <div class="mode-switcher">
    <button class="mode-btn active" data-mode="todo">ğŸ“ Todoãƒªã‚¹ãƒˆ</button>
    <button class="mode-btn" data-mode="memo">ğŸ“„ ãƒ¡ãƒ¢</button>
  </div>

  <div class="content-area">
    <div class="todo-container active">
      <h1>ã‚¿ã‚¹ã‚¯ç®¡ç†</h1>
      
      <div class="input-section">
        <input type="text" id="todoInput" placeholder="ä½•ã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ">
        <button class="btn-primary" id="addTodoBtn">ã‚¿ã‚¹ã‚¯è¿½åŠ </button>
      </div>

      <div class="sort-controls">
        <span class="sort-label">ä¸¦ã³æ›¿ãˆ:</span>
        <select class="sort-select" id="todoSort">
          <option value="newest">æ–°ã—ã„é †</option>
          <option value="oldest">å¤ã„é †</option>
          <option value="priority">å„ªå…ˆåº¦é †</option>
          <option value="duedate">æœŸé™é †</option>
          <option value="alphabetical">ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †</option>
        </select>
      </div>

      <div class="filter-tabs">
        <button class="filter-btn active" data-filter="all">ã™ã¹ã¦</button>
        <button class="filter-btn" data-filter="active">æœªå®Œäº†</button>
        <button class="filter-btn" data-filter="completed">å®Œäº†æ¸ˆã¿</button>
        <button class="filter-btn" data-filter="high">å„ªå…ˆåº¦: é«˜</button>
        <button class="filter-btn" data-filter="medium">å„ªå…ˆåº¦: ä¸­</button>
        <button class="filter-btn" data-filter="low">å„ªå…ˆåº¦: ä½</button>
        <button class="filter-btn" data-filter="overdue">æœŸé™åˆ‡ã‚Œ</button>
      </div>

      <ul class="todo-list" id="todoList"></ul>

      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="totalTasks">0</div>
          <div class="stat-label">åˆè¨ˆ</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="activeTasks">0</div>
          <div class="stat-label">æœªå®Œäº†</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="completedTasks">0</div>
          <div class="stat-label">å®Œäº†æ¸ˆã¿</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="completionRate">0%</div>
          <div class="stat-label">é”æˆç‡</div>
        </div>
      </div>

      <div class="export-section">
        <button class="btn-success" onclick="exportAllTodos()">ğŸ“¥ ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button class="btn-primary" onclick="clearCompleted()">ğŸ—‘ï¸ å®Œäº†æ¸ˆã¿ã‚’å‰Šé™¤</button>
      </div>
    </div>

    <div class="memo-container">
      <h1>ãƒ¡ãƒ¢ç®¡ç†</h1>
      
      <div class="memo-input-section">
        <input type="text" id="memoTitle" placeholder="ãƒ¡ãƒ¢ã‚¿ã‚¤ãƒˆãƒ«...">
        
        <div class="view-toggle">
          <button class="view-btn active" id="editViewBtn" onclick="switchMemoView('edit')">âœï¸ ç·¨é›†</button>
          <button class="view-btn" id="previewViewBtn" onclick="switchMemoView('preview')">ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
        </div>
        
        <div class="memo-toolbar">
          <button class="toolbar-btn" onclick="insertText('**å¤ªå­—**')"><strong>B</strong></button>
          <button class="toolbar-btn" onclick="insertText('*æ–œä½“*')"><em>I</em></button>
          <button class="toolbar-btn" onclick="insertText('~~æ‰“ã¡æ¶ˆã—ç·š~~')"><s>S</s></button>
          <button class="toolbar-btn" onclick="insertText('# ')">H1</button>
          <button class="toolbar-btn" onclick="insertText('## ')">H2</button>
          <button class="toolbar-btn" onclick="insertText('### ')">H3</button>
          <button class="toolbar-btn" onclick="insertText('- ')">â€¢ List</button>
          <button class="toolbar-btn" onclick="insertText('1. ')">1. List</button>
          <button class="toolbar-btn" onclick="insertText('[ ] ')">â˜ Task</button>
          <button class="toolbar-btn" onclick="insertText('```\n\n```')">&lt;/&gt; Code</button>
          <button class="toolbar-btn" onclick="insertText('> ')">â Quote</button>
          <button class="toolbar-btn" onclick="insertLink()">ğŸ”— Link</button>
          <button class="toolbar-btn" onclick="insertImage()">ğŸ–¼ï¸ Image</button>
          <button class="toolbar-btn" onclick="insertTable()">ğŸ“Š Table</button>
          <button class="toolbar-btn" onclick="insertHorizontalRule()">â”€ HR</button>
        </div>
        
        <textarea id="memoContent" placeholder="ãƒ¡ãƒ¢ã‚’ã“ã“ã«æ›¸ã„ã¦ãã ã•ã„...&#10;&#10;Markdownã‚’ã‚µãƒãƒ¼ãƒˆ:&#10;**å¤ªå­—** *æ–œä½“* ~~æ‰“ã¡æ¶ˆã—ç·š~~&#10;# è¦‹å‡ºã—1 ## è¦‹å‡ºã—2 ### è¦‹å‡ºã—3&#10;- ãƒªã‚¹ãƒˆ 1. ç•ªå·ä»˜ããƒªã‚¹ãƒˆ [ ] ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹&#10;> å¼•ç”¨ ``` ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ ``` [ãƒªãƒ³ã‚¯](URL)"></textarea>
        
        <div id="memoPreview" class="memo-preview"></div>
        
        <input type="text" id="memoTags" placeholder="ã‚¿ã‚° (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š: ä»•äº‹, ã‚¢ã‚¤ãƒ‡ã‚¢, é‡è¦)">
        
        <button class="btn-primary" id="addMemoBtn">ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>
      </div>

      <div class="sort-controls">
        <span class="sort-label">ä¸¦ã³æ›¿ãˆ:</span>
        <select class="sort-select" id="memoSort">
          <option value="newest">æ–°ã—ã„é †</option>
          <option value="oldest">å¤ã„é †</option>
          <option value="alphabetical">ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †</option>
          <option value="longest">é•·ã„é †</option>
        </select>
      </div>

      <div class="memo-filters" id="memoFilters">
        <button class="filter-btn active" onclick="filterMemosByTag('all')">ã™ã¹ã¦</button>
      </div>

      <div class="export-section">
        <button class="btn-success" onclick="exportAllMemos()">ğŸ“¥ ã™ã¹ã¦ã®ãƒ¡ãƒ¢ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      </div>

      <div class="memo-list" id="memoList"></div>
    </div>
  </div>
</main>

<!-- Modals -->
<div class="modal" id="searchModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeSearch()">âœ•</button>
    <h2 class="modal-title">ğŸ” æ¤œç´¢</h2>
    <input type="text" class="modal-input" id="searchInput" placeholder="ã‚¿ã‚¹ã‚¯ã‚„ãƒ¡ãƒ¢ã‚’æ¤œç´¢...">
    <div class="search-results" id="searchResults"></div>
  </div>
</div>

<div class="modal" id="editTodoModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeEditTodoModal()">âœ•</button>
    <h2 class="modal-title">ğŸ“ ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†</h2>
    <input type="text" class="modal-input" id="editTodoText" placeholder="ã‚¿ã‚¹ã‚¯ã®å†…å®¹">
    <select class="modal-select" id="editTodoPriority">
      <option value="">å„ªå…ˆåº¦ãªã—</option>
      <option value="high">é«˜</option>
      <option value="medium">ä¸­</option>
      <option value="low">ä½</option>
    </select>
    <input type="date" class="modal-input" id="editTodoDueDate" placeholder="æœŸé™">
    <input type="text" class="modal-input" id="editTodoTags" placeholder="ã‚¿ã‚° (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)">
    <textarea class="modal-textarea" id="editTodoNote" placeholder="ãƒ¡ãƒ¢"></textarea>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeEditTodoModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="modal-btn modal-btn-primary" onclick="saveEditedTodo()">ä¿å­˜</button>
    </div>
  </div>
</div>

<div class="modal" id="statsModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeStats()">âœ•</button>
    <h2 class="modal-title">ğŸ“Š çµ±è¨ˆæƒ…å ±</h2>
    <div id="statsContent"></div>
  </div>
</div>

<div class="modal" id="settingsModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeSettings()">âœ•</button>
    <h2 class="modal-title">âš™ï¸ è¨­å®š</h2>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="importData()">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      <button class="modal-btn modal-btn-primary" onclick="exportAllData()">ğŸ“¥ ã™ã¹ã¦ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button class="modal-btn modal-btn-secondary" onclick="clearAllData()">ğŸ—‘ï¸ ã™ã¹ã¦ã‚’å‰Šé™¤</button>
    </div>
  </div>
</div>

<div class="modal" id="shortcutsModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeKeyboardShortcuts()">âœ•</button>
    <h2 class="modal-title">âŒ¨ï¸ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</h2>
    <div class="shortcuts-list">
      <div class="shortcut-section">
        <h3>å…¨èˆ¬</h3>
        <div class="shortcut-item"><kbd>Ctrl/Cmd + K</kbd><span>æ¤œç´¢ã‚’é–‹ã</span></div>
        <div class="shortcut-item"><kbd>Esc</kbd><span>ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹</span></div>
      </div>
      <div class="shortcut-section">
        <h3>ãƒ¡ãƒ¢ç·¨é›†</h3>
        <div class="shortcut-item"><kbd>Ctrl/Cmd + B</kbd><span>å¤ªå­—</span></div>
        <div class="shortcut-item"><kbd>Ctrl/Cmd + I</kbd><span>æ–œä½“</span></div>
        <div class="shortcut-item"><kbd>Ctrl/Cmd + K</kbd><span>ãƒªãƒ³ã‚¯æŒ¿å…¥</span></div>
        <div class="shortcut-item"><kbd>Ctrl/Cmd + Shift + K</kbd><span>ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯</span></div>
        <div class="shortcut-item"><kbd>Ctrl/Cmd + Enter</kbd><span>ãƒ¡ãƒ¢ã‚’ä¿å­˜</span></div>
      </div>
      <div class="shortcut-section">
        <h3>Todo</h3>
        <div class="shortcut-item"><kbd>Enter</kbd><span>ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </span></div>
      </div>
    </div>
  </div>
</div>

<div class="confirm-dialog" id="confirmDialog">
  <div class="confirm-dialog-content">
    <div class="confirm-dialog-title" id="confirmTitle">ç¢ºèª</div>
    <div class="confirm-dialog-message" id="confirmMessage">ã“ã®æ“ä½œã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</div>
    <div class="confirm-dialog-actions">
      <button class="confirm-btn confirm-btn-cancel" id="confirmCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="confirm-btn confirm-btn-danger" id="confirmOkBtn">OK</button>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€ ãƒ‡ãƒ¼ã‚¿ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let todos = [];
let memos = [];
let currentFilter = 'all';
let currentMemoFilter = 'all';
let editingTodoId = null;
let currentLang = 'ja';
let allMemoTags = new Set();
let currentTodoSort = 'newest';
let currentMemoSort = 'newest';
let currentMemoView = 'edit';
let todoSortable = null;

const STORAGE_KEY_TODOS = 'todo_memo_todos';
const STORAGE_KEY_MEMOS = 'todo_memo_memos';

function saveData() {
  try {
    localStorage.setItem(STORAGE_KEY_TODOS, JSON.stringify(todos));
    localStorage.setItem(STORAGE_KEY_MEMOS, JSON.stringify(memos));
  } catch (e) {
    console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
  }
}

function loadData() {
  try {
    const storedTodos = localStorage.getItem(STORAGE_KEY_TODOS);
    const storedMemos = localStorage.getItem(STORAGE_KEY_MEMOS);
    todos = storedTodos ? JSON.parse(storedTodos) : [];
    memos = storedMemos ? JSON.parse(storedMemos) : [];
  } catch (e) {
    console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
    todos = [];
    memos = [];
  }
  updateMemoTags();
  renderTodos();
  renderMemos();
}

// â”€â”€â”€ marked è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (typeof marked !== 'undefined') {
  marked.setOptions({ breaks: true, gfm: true });
}

// â”€â”€â”€ ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function customConfirm(message, title = 'ç¢ºèª', showCancel = true) {
  return new Promise((resolve) => {
    const dialog = document.getElementById('confirmDialog');
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    const okBtn = document.getElementById('confirmOkBtn');
    const cancelBtn = document.getElementById('confirmCancelBtn');
    cancelBtn.style.display = showCancel ? 'block' : 'none';
    dialog.classList.add('active');

    const cleanup = (result) => {
      dialog.classList.remove('active');
      document.removeEventListener('keydown', handleEsc);
      okBtn.removeEventListener('click', handleOk);
      cancelBtn.removeEventListener('click', handleCancel);
      resolve(result);
    };
    const handleOk = () => cleanup(true);
    const handleCancel = () => cleanup(false);
    const handleEsc = (e) => { if (e.key === 'Escape') cleanup(showCancel ? false : true); };

    okBtn.addEventListener('click', handleOk);
    cancelBtn.addEventListener('click', handleCancel);
    document.addEventListener('keydown', handleEsc);
  });
}

// â”€â”€â”€ ãƒ¡ãƒ¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchMemoView(view) {
  currentMemoView = view;
  const textarea = document.getElementById('memoContent');
  const preview = document.getElementById('memoPreview');
  const editBtn = document.getElementById('editViewBtn');
  const previewBtn = document.getElementById('previewViewBtn');
  if (view === 'edit') {
    textarea.style.display = 'block';
    preview.classList.remove('active');
    editBtn.classList.add('active');
    previewBtn.classList.remove('active');
  } else {
    textarea.style.display = 'none';
    preview.classList.add('active');
    editBtn.classList.remove('active');
    previewBtn.classList.add('active');
    updateMemoPreview();
  }
}

function updateMemoPreview() {
  const content = document.getElementById('memoContent').value;
  const preview = document.getElementById('memoPreview');
  preview.innerHTML = typeof marked !== 'undefined'
    ? marked.parse(content || '*ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“*')
    : content.replace(/\n/g, '<br>');
}

// â”€â”€â”€ Todo æ“ä½œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addTodo() {
  const text = document.getElementById('todoInput').value.trim();
  if (!text) return;
  todos.unshift({
    id: Date.now(),
    text,
    completed: false,
    date: new Date().toLocaleString(currentLang === 'ja' ? 'ja-JP' : 'en-US'),
    priority: '',
    tags: [],
    dueDate: null,
    note: ''
  });
  document.getElementById('todoInput').value = '';
  saveData();
  renderTodos();
}

function toggleTodo(id) {
  const todo = todos.find(t => t.id === id);
  if (!todo) return;
  todo.completed = !todo.completed;
  if (todo.completed) {
    todo.completedDate = new Date().toLocaleString(currentLang === 'ja' ? 'ja-JP' : 'en-US');
  } else {
    delete todo.completedDate;
  }
  saveData();
  renderTodos();
}

async function deleteTodo(id) {
  const confirmed = await customConfirm(
    currentLang === 'ja' ? 'ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹?' : 'Delete this task?',
    'âš ï¸ ' + (currentLang === 'ja' ? 'å‰Šé™¤ç¢ºèª' : 'Confirm Delete')
  );
  if (confirmed) {
    todos.splice(todos.findIndex(t => t.id === id), 1);
    saveData();
    renderTodos();
  }
}

function duplicateTodo(id) {
  const todo = todos.find(t => t.id === id);
  if (!todo) return;
  todos.unshift({
    ...todo,
    id: Date.now(),
    completed: false,
    date: new Date().toLocaleString(currentLang === 'ja' ? 'ja-JP' : 'en-US'),
    text: todo.text + (currentLang === 'ja' ? ' (ã‚³ãƒ”ãƒ¼)' : ' (Copy)')
  });
  saveData();
  renderTodos();
}

function exportTodo(id) {
  const todo = todos.find(t => t.id === id);
  if (!todo) return;
  const t = translations[currentLang];
  let content = `${currentLang === 'ja' ? 'ã‚¿ã‚¹ã‚¯' : 'Task'}: ${todo.text}\n${'='.repeat(50)}\n\n`;
  content += `${currentLang === 'ja' ? 'çŠ¶æ…‹' : 'Status'}: ${todo.completed ? 'âœ“ ' + t.completed : 'â˜ ' + t.active}\n`;
  if (todo.priority) content += `${currentLang === 'ja' ? 'å„ªå…ˆåº¦' : 'Priority'}: ${t['priority_' + todo.priority]}\n`;
  if (todo.dueDate) content += `${currentLang === 'ja' ? 'æœŸé™' : 'Due Date'}: ${new Date(todo.dueDate).toLocaleDateString()}\n`;
  if (todo.tags && todo.tags.length > 0) content += `${currentLang === 'ja' ? 'ã‚¿ã‚°' : 'Tags'}: ${todo.tags.join(', ')}\n`;
  if (todo.note) content += `\n${currentLang === 'ja' ? 'ãƒ¡ãƒ¢' : 'Note'}:\n${todo.note}\n`;
  content += `\n${currentLang === 'ja' ? 'ä½œæˆæ—¥æ™‚' : 'Created'}: ${todo.date || ''}`;
  if (todo.completedDate) content += `\n${currentLang === 'ja' ? 'å®Œäº†æ—¥æ™‚' : 'Completed'}: ${todo.completedDate}`;
  downloadTextFile(todo.text.substring(0, 30).replace(/[^a-zA-Z0-9_\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, '_') + '.txt', content);
}

async function exportAllTodos() {
  const t = translations[currentLang];
  if (todos.length === 0) {
    await customConfirm(t.no_tasks_export, 'â„¹ï¸ Info', false);
    return;
  }
  const header = currentLang === 'ja' ? 'ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ' : 'Task List';
  let content = header + '\n' + '='.repeat(50) + '\n\n';
  const active = todos.filter(t => !t.completed);
  const completed = todos.filter(t => t.completed);
  if (active.length > 0) {
    content += `ã€${currentLang === 'ja' ? 'æœªå®Œäº†' : 'Active'}ã€‘\n`;
    active.forEach((todo, i) => {
      content += `${i + 1}. â˜ ${todo.text}`;
      if (todo.priority) content += ` [${t['priority_' + todo.priority]}]`;
      if (todo.dueDate) content += ` (æœŸé™: ${new Date(todo.dueDate).toLocaleDateString()})`;
      if (todo.tags && todo.tags.length > 0) content += ` #${todo.tags.join(' #')}`;
      content += '\n';
    });
    content += '\n';
  }
  if (completed.length > 0) {
    content += `ã€${currentLang === 'ja' ? 'å®Œäº†æ¸ˆã¿' : 'Completed'}ã€‘\n`;
    completed.forEach((todo, i) => {
      content += `${i + 1}. â˜‘ ${todo.text}\n`;
    });
  }
  content += '\n' + '='.repeat(50) + '\n';
  content += `åˆè¨ˆ: ${todos.length} | æœªå®Œäº†: ${active.length} | å®Œäº†æ¸ˆã¿: ${completed.length}\n`;
  downloadTextFile(`todos_${new Date().toISOString().split('T')[0]}.txt`, content);
}

async function clearCompleted() {
  const confirmed = await customConfirm(
    currentLang === 'ja' ? 'å®Œäº†æ¸ˆã¿ã®ã‚¿ã‚¹ã‚¯ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹?' : 'Clear all completed tasks?',
    'âš ï¸ ' + (currentLang === 'ja' ? 'ä¸€æ‹¬å‰Šé™¤ç¢ºèª' : 'Confirm Clear')
  );
  if (confirmed) {
    todos = todos.filter(t => !t.completed);
    saveData();
    renderTodos();
  }
}

function openEditTodoModal(id) {
  editingTodoId = id;
  const todo = todos.find(t => t.id === id);
  if (!todo) return;
  document.getElementById('editTodoText').value = todo.text;
  document.getElementById('editTodoPriority').value = todo.priority || '';
  document.getElementById('editTodoDueDate').value = todo.dueDate || '';
  document.getElementById('editTodoTags').value = todo.tags ? todo.tags.join(', ') : '';
  document.getElementById('editTodoNote').value = todo.note || '';
  document.getElementById('editTodoModal').classList.add('active');
}

function closeEditTodoModal() {
  document.getElementById('editTodoModal').classList.remove('active');
  editingTodoId = null;
}

function saveEditedTodo() {
  if (!editingTodoId) return;
  const todo = todos.find(t => t.id === editingTodoId);
  if (!todo) return;
  todo.text = document.getElementById('editTodoText').value.trim();
  todo.priority = document.getElementById('editTodoPriority').value;
  todo.dueDate = document.getElementById('editTodoDueDate').value;
  todo.note = document.getElementById('editTodoNote').value.trim();
  const tagInput = document.getElementById('editTodoTags').value.trim();
  todo.tags = tagInput ? tagInput.split(',').map(t => t.trim()).filter(t => t) : [];
  saveData();
  renderTodos();
  closeEditTodoModal();
}

function getDueDateStatus(dueDate) {
  if (!dueDate) return null;
  const today = new Date(); today.setHours(0, 0, 0, 0);
  const due = new Date(dueDate); due.setHours(0, 0, 0, 0);
  const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
  if (diffDays < 0) return { text: currentLang === 'ja' ? 'æœŸé™åˆ‡ã‚Œ' : 'Overdue', class: 'overdue' };
  if (diffDays === 0) return { text: currentLang === 'ja' ? 'ä»Šæ—¥' : 'Today', class: 'due-today' };
  if (diffDays === 1) return { text: currentLang === 'ja' ? 'æ˜æ—¥' : 'Tomorrow', class: 'due-tomorrow' };
  return { text: new Date(dueDate).toLocaleDateString(currentLang === 'ja' ? 'ja-JP' : 'en-US'), class: '' };
}

function sortTodos(arr) {
  const sorted = [...arr];
  switch (currentTodoSort) {
    case 'oldest': return sorted.reverse();
    case 'priority':
      const order = { 'high': 0, 'medium': 1, 'low': 2, '': 3 };
      return sorted.sort((a, b) => order[a.priority || ''] - order[b.priority || '']);
    case 'duedate':
      return sorted.sort((a, b) => {
        if (!a.dueDate && !b.dueDate) return 0;
        if (!a.dueDate) return 1;
        if (!b.dueDate) return -1;
        return new Date(a.dueDate) - new Date(b.dueDate);
      });
    case 'alphabetical': return sorted.sort((a, b) => a.text.localeCompare(b.text));
    default: return sorted;
  }
}

function renderTodos() {
  const t = translations[currentLang];
  let filtered = todos.filter(todo => {
    if (currentFilter === 'active') return !todo.completed;
    if (currentFilter === 'completed') return todo.completed;
    if (currentFilter === 'high') return todo.priority === 'high';
    if (currentFilter === 'medium') return todo.priority === 'medium';
    if (currentFilter === 'low') return todo.priority === 'low';
    if (currentFilter === 'overdue') {
      if (!todo.dueDate || todo.completed) return false;
      const today = new Date(); today.setHours(0, 0, 0, 0);
      const due = new Date(todo.dueDate); due.setHours(0, 0, 0, 0);
      return due < today;
    }
    return true;
  });
  filtered = sortTodos(filtered);

  const list = document.getElementById('todoList');
  if (filtered.length === 0) {
    list.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><div class="empty-state-text">${t.no_tasks}</div></div>`;
  } else {
    list.innerHTML = filtered.map(todo => {
      const dueStatus = getDueDateStatus(todo.dueDate);
      return `
        <li class="todo-item ${todo.completed ? 'completed' : ''}" data-id="${todo.id}">
          <div class="todo-main-row">
            <div class="checkbox ${todo.completed ? 'checked' : ''}" data-action="toggle" data-id="${todo.id}"></div>
            <div class="todo-text">${todo.text}</div>
            <div class="todo-actions">
              ${todo.priority ? `<span class="priority-badge priority-${todo.priority}">${t['priority_' + todo.priority]}</span>` : ''}
              ${dueStatus ? `<span class="due-date-badge ${dueStatus.class}">${dueStatus.text}</span>` : ''}
              <button class="action-btn duplicate" data-action="duplicate" data-id="${todo.id}">ğŸ“‹</button>
              <button class="action-btn edit" data-action="edit" data-id="${todo.id}">âœï¸</button>
              <button class="action-btn export" data-action="export" data-id="${todo.id}">ğŸ’¾</button>
              <button class="action-btn" data-action="delete" data-id="${todo.id}">ğŸ—‘ï¸</button>
            </div>
          </div>
          ${todo.tags && todo.tags.length > 0 ? `<div class="todo-meta">${todo.tags.map(tag => `<span class="todo-tag">#${tag}</span>`).join('')}</div>` : ''}
          ${todo.note ? `<div class="todo-meta"><span style="color:#d1d5db">${todo.note}</span></div>` : ''}
        </li>`;
    }).join('');
  }
  updateStats();

  if (typeof Sortable !== 'undefined') {
    if (todoSortable) todoSortable.destroy();
    todoSortable = Sortable.create(list, {
      animation: 150,
      handle: '.todo-text',
      onEnd: () => {
        const newOrder = Array.from(list.children).map(el => parseInt(el.dataset.id));
        const reordered = [];
        newOrder.forEach(id => { const t = todos.find(t => t.id === id); if (t) reordered.push(t); });
        todos = reordered;
        saveData();
      }
    });
  }
}

function updateStats() {
  const total = todos.length;
  const completed = todos.filter(t => t.completed).length;
  const active = total - completed;
  const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
  document.getElementById('totalTasks').textContent = total;
  document.getElementById('activeTasks').textContent = active;
  document.getElementById('completedTasks').textContent = completed;
  document.getElementById('completionRate').textContent = rate + '%';
}

// â”€â”€â”€ Memo æ“ä½œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addMemo() {
  const title = document.getElementById('memoTitle').value.trim();
  const content = document.getElementById('memoContent').value.trim();
  if (!title && !content) return;
  const tagInput = document.getElementById('memoTags').value.trim();
  const tags = tagInput ? tagInput.split(',').map(t => t.trim()).filter(t => t) : [];
  memos.unshift({
    id: Date.now(),
    title: title || (currentLang === 'ja' ? 'ç„¡é¡Œ' : 'Untitled'),
    content,
    date: new Date().toLocaleString(currentLang === 'ja' ? 'ja-JP' : 'en-US'),
    tags
  });
  document.getElementById('memoTitle').value = '';
  document.getElementById('memoContent').value = '';
  document.getElementById('memoTags').value = '';
  saveData();
  updateMemoTags();
  renderMemos();
}

async function deleteMemo(id) {
  const confirmed = await customConfirm(
    currentLang === 'ja' ? 'ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹?' : 'Delete this memo?',
    'âš ï¸ ' + (currentLang === 'ja' ? 'å‰Šé™¤ç¢ºèª' : 'Confirm Delete')
  );
  if (confirmed) {
    memos.splice(memos.findIndex(m => m.id === id), 1);
    saveData();
    updateMemoTags();
    renderMemos();
  }
}

function duplicateMemo(id) {
  const memo = memos.find(m => m.id === id);
  if (!memo) return;
  memos.unshift({
    ...memo,
    id: Date.now(),
    title: memo.title + (currentLang === 'ja' ? ' (ã‚³ãƒ”ãƒ¼)' : ' (Copy)'),
    date: new Date().toLocaleString(currentLang === 'ja' ? 'ja-JP' : 'en-US')
  });
  saveData();
  updateMemoTags();
  renderMemos();
}

function editMemo(id) {
  const memo = memos.find(m => m.id === id);
  if (!memo) return;
  document.getElementById('memoTitle').value = memo.title;
  document.getElementById('memoContent').value = memo.content;
  document.getElementById('memoTags').value = memo.tags ? memo.tags.join(', ') : '';
  memos.splice(memos.findIndex(m => m.id === id), 1);
  saveData();
  updateMemoTags();
  renderMemos();
  window.scrollTo({ top: 0, behavior: 'smooth' });
  document.getElementById('memoTitle').focus();
}

function exportMemo(id) {
  const memo = memos.find(m => m.id === id);
  if (!memo) return;
  let content = memo.title + '\n' + '='.repeat(memo.title.length) + '\n\n' + memo.content + '\n\n';
  if (memo.tags && memo.tags.length > 0) content += `ã‚¿ã‚°: ${memo.tags.join(', ')}\n\n`;
  content += `---\nä½œæˆæ—¥æ™‚: ${memo.date}`;
  downloadTextFile(memo.title.replace(/[^a-zA-Z0-9_\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, '_') + '.txt', content);
}

async function exportAllMemos() {
  if (memos.length === 0) {
    await customConfirm(currentLang === 'ja' ? 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“' : 'No memos to export', 'â„¹ï¸ Info', false);
    return;
  }
  let content = (currentLang === 'ja' ? 'ãƒ¡ãƒ¢ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³' : 'Memo Collection') + '\n' + '='.repeat(50) + '\n\n';
  memos.forEach((memo, i) => {
    content += `${i + 1}. ${memo.title}\n${'-'.repeat(memo.title.length + 3)}\n${memo.content}\n`;
    if (memo.tags && memo.tags.length > 0) content += `ã‚¿ã‚°: ${memo.tags.join(', ')}\n`;
    content += `ä½œæˆæ—¥æ™‚: ${memo.date}\n\n${'='.repeat(50)}\n\n`;
  });
  downloadTextFile(`all_memos_${new Date().toISOString().split('T')[0]}.txt`, content);
}

function updateMemoTags() {
  allMemoTags.clear();
  memos.forEach(memo => { if (memo.tags) memo.tags.forEach(tag => allMemoTags.add(tag)); });
  const filtersDiv = document.getElementById('memoFilters');
  const allLabel = currentLang === 'ja' ? 'ã™ã¹ã¦' : 'All';
  filtersDiv.innerHTML =
    `<button class="filter-btn ${currentMemoFilter === 'all' ? 'active' : ''}" onclick="filterMemosByTag('all')">${allLabel}</button>` +
    Array.from(allMemoTags).map(tag =>
      `<button class="filter-btn ${currentMemoFilter === tag ? 'active' : ''}" onclick="filterMemosByTag('${tag}')">#${tag}</button>`
    ).join('');
}

function filterMemosByTag(tag) {
  currentMemoFilter = tag;
  updateMemoTags();
  renderMemos();
}

function sortMemos(arr) {
  const sorted = [...arr];
  switch (currentMemoSort) {
    case 'oldest': return sorted.reverse();
    case 'alphabetical': return sorted.sort((a, b) => a.title.localeCompare(b.title));
    case 'longest': return sorted.sort((a, b) => b.content.length - a.content.length);
    default: return sorted;
  }
}

function renderMemos() {
  const t = translations[currentLang];
  let filtered = memos.filter(memo => currentMemoFilter === 'all' || (memo.tags && memo.tags.includes(currentMemoFilter)));
  filtered = sortMemos(filtered);
  const list = document.getElementById('memoList');
  if (filtered.length === 0) {
    list.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon">ğŸ“</div><div class="empty-state-text">${t.no_memos}</div></div>`;
  } else {
    list.innerHTML = filtered.map(memo => `
      <div class="memo-item" data-id="${memo.id}">
        <div class="memo-header">
          <div class="memo-title">${memo.title}</div>
          <div class="memo-actions">
            <button class="action-btn duplicate" data-action="duplicate" data-id="${memo.id}">ğŸ“‹</button>
            <button class="action-btn edit" data-action="edit" data-id="${memo.id}">âœï¸</button>
            <button class="action-btn export" data-action="export" data-id="${memo.id}">ğŸ’¾</button>
            <button class="action-btn" data-action="delete" data-id="${memo.id}">ğŸ—‘ï¸</button>
          </div>
        </div>
        <div class="memo-content-preview">${typeof marked !== 'undefined' ? marked.parse(memo.content.substring(0, 200) + (memo.content.length > 200 ? '...' : '')) : memo.content.substring(0, 200)}</div>
        ${memo.tags && memo.tags.length > 0 ? `<div class="memo-tags-display">${memo.tags.map(tag => `<span class="memo-tag-item">#${tag}</span>`).join('')}</div>` : ''}
        <div class="memo-date">${memo.date}</div>
      </div>`).join('');
  }
}

// â”€â”€â”€ Markdown æŒ¿å…¥ãƒ˜ãƒ«ãƒ‘ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function insertText(text) {
  const ta = document.getElementById('memoContent');
  const start = ta.selectionStart, end = ta.selectionEnd;
  const selected = ta.value.substring(start, end);
  let inserted = text, cursor = text.length;
  if (text === '**å¤ªå­—**' || text === '*æ–œä½“*' || text === '~~æ‰“ã¡æ¶ˆã—ç·š~~') {
    let m = text === '**å¤ªå­—**' ? '**' : text === '*æ–œä½“*' ? '*' : '~~';
    inserted = selected ? m + selected + m : text;
    cursor = selected ? inserted.length : m.length;
  } else if (text.includes('```')) {
    inserted = selected ? '```\n' + selected + '\n```' : '```\n\n```';
    cursor = selected ? inserted.length : 4;
  }
  ta.value = ta.value.substring(0, start) + inserted + ta.value.substring(end);
  ta.focus();
  ta.selectionStart = ta.selectionEnd = start + cursor;
}

function insertLink() {
  const ta = document.getElementById('memoContent');
  const start = ta.selectionStart, end = ta.selectionEnd;
  const selected = ta.value.substring(start, end);
  const inserted = selected ? `[${selected}](URL)` : '[ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ](URL)';
  ta.value = ta.value.substring(0, start) + inserted + ta.value.substring(end);
  ta.focus();
  ta.selectionStart = start + (selected ? inserted.length - 4 : 1);
  ta.selectionEnd = start + (selected ? inserted.length - 1 : 12);
}

function insertImage() {
  const ta = document.getElementById('memoContent');
  const s = ta.selectionStart;
  const ins = '![ç”»åƒã®èª¬æ˜](ç”»åƒã®URL)';
  ta.value = ta.value.substring(0, s) + ins + ta.value.substring(ta.selectionEnd);
  ta.focus(); ta.selectionStart = s + 2; ta.selectionEnd = s + 8;
}

function insertTable() {
  const ta = document.getElementById('memoContent');
  const s = ta.selectionStart;
  const tbl = `| åˆ—1 | åˆ—2 | åˆ—3 |\n| --- | --- | --- |\n| ãƒ‡ãƒ¼ã‚¿1 | ãƒ‡ãƒ¼ã‚¿2 | ãƒ‡ãƒ¼ã‚¿3 |\n| ãƒ‡ãƒ¼ã‚¿4 | ãƒ‡ãƒ¼ã‚¿5 | ãƒ‡ãƒ¼ã‚¿6 |`;
  ta.value = ta.value.substring(0, s) + tbl + ta.value.substring(ta.selectionEnd);
  ta.focus(); ta.selectionStart = ta.selectionEnd = s + tbl.length;
}

function insertHorizontalRule() {
  const ta = document.getElementById('memoContent');
  const s = ta.selectionStart;
  const hr = '\n---\n';
  ta.value = ta.value.substring(0, s) + hr + ta.value.substring(ta.selectionEnd);
  ta.focus(); ta.selectionStart = ta.selectionEnd = s + hr.length;
}

function downloadTextFile(filename, content) {
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
}

// â”€â”€â”€ æ¤œç´¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSearch() {
  document.getElementById('searchModal').classList.add('active');
  document.getElementById('searchInput').focus();
}

function closeSearch() {
  document.getElementById('searchModal').classList.remove('active');
  document.getElementById('searchInput').value = '';
  document.getElementById('searchResults').innerHTML = '';
}

function jumpTo(type, id) {
  closeSearch();
  const modeButtons = document.querySelectorAll('.mode-btn');
  const todoContainer = document.querySelector('.todo-container');
  const memoContainer = document.querySelector('.memo-container');
  modeButtons.forEach(btn => btn.classList.remove('active'));
  if (type === 'todo') {
    document.querySelector('[data-mode="todo"]').classList.add('active');
    todoContainer.classList.add('active');
    memoContainer.classList.remove('active');
    setTimeout(() => {
      const el = document.querySelector(`[data-id="${id}"]`);
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.style.boxShadow = '0 0 30px rgba(103,6,118,0.8)';
        setTimeout(() => el.style.boxShadow = '', 2000);
      }
    }, 100);
  } else {
    document.querySelector('[data-mode="memo"]').classList.add('active');
    todoContainer.classList.remove('active');
    memoContainer.classList.add('active');
  }
}

// â”€â”€â”€ çµ±è¨ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showStats() {
  const modal = document.getElementById('statsModal');
  const content = document.getElementById('statsContent');
  const t = translations[currentLang];
  const totalTodos = todos.length;
  const activeTodos = todos.filter(t => !t.completed).length;
  const completedTodos = todos.filter(t => t.completed).length;
  const highPriority = todos.filter(t => t.priority === 'high').length;
  const mediumPriority = todos.filter(t => t.priority === 'medium').length;
  const lowPriority = todos.filter(t => t.priority === 'low').length;
  const totalMemos = memos.length;

  content.innerHTML = `
    <div class="stats">
      <div class="stat-item"><div class="stat-value">${totalTodos}</div><div class="stat-label">${t.total_tasks}</div></div>
      <div class="stat-item"><div class="stat-value">${activeTodos}</div><div class="stat-label">${t.active_tasks}</div></div>
      <div class="stat-item"><div class="stat-value">${completedTodos}</div><div class="stat-label">${t.completed_tasks}</div></div>
      <div class="stat-item"><div class="stat-value">${highPriority}</div><div class="stat-label">${t.high_priority_tasks}</div></div>
      <div class="stat-item"><div class="stat-value">${totalMemos}</div><div class="stat-label">${t.total_memos}</div></div>
      <div class="stat-item"><div class="stat-value">${allMemoTags.size}</div><div class="stat-label">${t.tags_in_use}</div></div>
    </div>
    <div class="chart-container" style="margin-top:2rem"><canvas id="statsChart"></canvas></div>
    <div class="chart-container"><canvas id="priorityChart"></canvas></div>`;

  modal.classList.add('active');

  setTimeout(() => {
    if (typeof Chart === 'undefined') return;
    new Chart(document.getElementById('statsChart'), {
      type: 'doughnut',
      data: {
        labels: [t.active_tasks, t.completed_tasks],
        datasets: [{ data: [activeTodos, completedTodos], backgroundColor: ['#a855f7', '#10b981'], borderColor: ['#670676', '#059669'], borderWidth: 2 }]
      },
      options: { responsive: true, plugins: { legend: { labels: { color: '#fff' }, position: 'bottom' }, title: { display: true, text: currentLang === 'ja' ? 'ã‚¿ã‚¹ã‚¯å®Œäº†çŠ¶æ³' : 'Task Completion Status', color: '#a855f7', font: { size: 16, weight: 'bold' } } } }
    });
    new Chart(document.getElementById('priorityChart'), {
      type: 'bar',
      data: {
        labels: [t.priority_high, t.priority_medium, t.priority_low],
        datasets: [{ label: currentLang === 'ja' ? 'ã‚¿ã‚¹ã‚¯æ•°' : 'Tasks', data: [highPriority, mediumPriority, lowPriority], backgroundColor: ['#ef4444', '#fbbf24', '#10b981'], borderColor: ['#dc2626', '#f59e0b', '#059669'], borderWidth: 2 }]
      },
      options: { responsive: true, plugins: { legend: { labels: { color: '#fff' } }, title: { display: true, text: currentLang === 'ja' ? 'å„ªå…ˆåº¦åˆ¥ã‚¿ã‚¹ã‚¯æ•°' : 'Tasks by Priority', color: '#a855f7', font: { size: 16, weight: 'bold' } } }, scales: { y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: 'rgba(103,6,118,0.2)' } }, x: { ticks: { color: '#fff' }, grid: { color: 'rgba(103,6,118,0.2)' } } } }
    });
  }, 100);
}

function closeStats() { document.getElementById('statsModal').classList.remove('active'); }

// â”€â”€â”€ è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSettings() { document.getElementById('settingsModal').classList.add('active'); }
function closeSettings() { document.getElementById('settingsModal').classList.remove('active'); }
function showKeyboardShortcuts() { document.getElementById('shortcutsModal').classList.add('active'); }
function closeKeyboardShortcuts() { document.getElementById('shortcutsModal').classList.remove('active'); }

function exportAllData() {
  const data = { todos, memos, exportDate: new Date().toISOString() };
  downloadTextFile(`todo-memo-backup-${new Date().toISOString().split('T')[0]}.json`, JSON.stringify(data, null, 2));
}

function importData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (ev) => {
      try {
        const data = JSON.parse(ev.target.result);
        const confirmed = await customConfirm(
          currentLang === 'ja' ? 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ç¶šã‘ã¾ã™ã‹?' : 'Importing will overwrite current data. Continue?',
          'âš ï¸ ' + (currentLang === 'ja' ? 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆç¢ºèª' : 'Confirm Import')
        );
        if (confirmed) {
          if (data.todos) todos = data.todos;
          if (data.memos) memos = data.memos;
          saveData();
          updateMemoTags();
          renderTodos();
          renderMemos();
          await customConfirm(currentLang === 'ja' ? 'ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ!' : 'Data imported successfully!', 'âœ… ' + (currentLang === 'ja' ? 'æˆåŠŸ' : 'Success'), false);
          closeSettings();
        }
      } catch (err) {
        await customConfirm(currentLang === 'ja' ? 'ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ' : 'Failed to load file', 'âŒ Error', false);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

async function clearAllData() {
  const c1 = await customConfirm(
    currentLang === 'ja' ? 'ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹? ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚' : 'Delete all data? This cannot be undone.',
    'âš ï¸ ' + (currentLang === 'ja' ? 'å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤' : 'Clear All Data')
  );
  if (c1) {
    const c2 = await customConfirm(
      currentLang === 'ja' ? 'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹?' : 'Are you sure?',
      'âš ï¸âš ï¸ ' + (currentLang === 'ja' ? 'æœ€çµ‚ç¢ºèª' : 'Final Confirmation')
    );
    if (c2) {
      todos = []; memos = [];
      saveData();
      updateMemoTags();
      renderTodos();
      renderMemos();
      closeSettings();
    }
  }
}

// â”€â”€â”€ ç¿»è¨³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const translations = {
  ja: {
    no_tasks: 'ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', no_memos: 'ã¾ã ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“',
    completed: 'å®Œäº†', active: 'æœªå®Œäº†',
    priority_high: 'é«˜', priority_medium: 'ä¸­', priority_low: 'ä½',
    total_tasks: 'ç·ã‚¿ã‚¹ã‚¯æ•°', active_tasks: 'æœªå®Œäº†ã‚¿ã‚¹ã‚¯', completed_tasks: 'å®Œäº†æ¸ˆã¿ã‚¿ã‚¹ã‚¯',
    high_priority_tasks: 'é«˜å„ªå…ˆåº¦ã‚¿ã‚¹ã‚¯', total_memos: 'ç·ãƒ¡ãƒ¢æ•°', tags_in_use: 'ä½¿ç”¨ä¸­ã®ã‚¿ã‚°',
    no_tasks_export: 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“'
  },
  en: {
    no_tasks: 'No tasks found', no_memos: 'No memos yet',
    completed: 'Completed', active: 'Active',
    priority_high: 'High', priority_medium: 'Medium', priority_low: 'Low',
    total_tasks: 'Total Tasks', active_tasks: 'Active Tasks', completed_tasks: 'Completed Tasks',
    high_priority_tasks: 'High Priority Tasks', total_memos: 'Total Memos', tags_in_use: 'Tags in Use',
    no_tasks_export: 'No tasks to export'
  }
};

// â”€â”€â”€ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('addTodoBtn').addEventListener('click', addTodo);
document.getElementById('todoInput').addEventListener('keypress', e => { if (e.key === 'Enter') addTodo(); });

document.getElementById('todoList').addEventListener('click', function(e) {
  const target = e.target.closest('[data-action]');
  if (!target) return;
  e.stopPropagation();
  const action = target.dataset.action, id = parseInt(target.dataset.id);
  if (!action || !id) return;
  switch (action) {
    case 'toggle': toggleTodo(id); break;
    case 'delete': deleteTodo(id); break;
    case 'duplicate': duplicateTodo(id); break;
    case 'edit': openEditTodoModal(id); break;
    case 'export': exportTodo(id); break;
  }
});

document.querySelectorAll('.filter-tabs .filter-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.filter-tabs .filter-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    currentFilter = this.dataset.filter;
    renderTodos();
  });
});

document.getElementById('todoSort').addEventListener('change', function() {
  currentTodoSort = this.value;
  renderTodos();
});

document.getElementById('addMemoBtn').addEventListener('click', addMemo);

document.getElementById('memoList').addEventListener('click', function(e) {
  const target = e.target.closest('[data-action]');
  if (!target) return;
  e.stopPropagation();
  const action = target.dataset.action, id = parseInt(target.dataset.id);
  if (!action || !id) return;
  switch (action) {
    case 'delete': deleteMemo(id); break;
    case 'duplicate': duplicateMemo(id); break;
    case 'edit': editMemo(id); break;
    case 'export': exportMemo(id); break;
  }
});

document.getElementById('memoTitle').addEventListener('keypress', e => {
  if (e.key === 'Enter') { e.preventDefault(); document.getElementById('memoContent').focus(); }
});

document.getElementById('memoContent').addEventListener('keypress', e => {
  if (e.key === 'Enter' && e.ctrlKey) addMemo();
});

document.getElementById('memoContent').addEventListener('input', () => {
  if (currentMemoView === 'preview') updateMemoPreview();
});

document.getElementById('memoSort').addEventListener('change', function() {
  currentMemoSort = this.value;
  renderMemos();
});

document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    const mode = this.dataset.mode;
    document.querySelector('.todo-container').classList.toggle('active', mode === 'todo');
    document.querySelector('.memo-container').classList.toggle('active', mode === 'memo');
  });
});

document.getElementById('langSwitcher').addEventListener('click', () => {
  currentLang = currentLang === 'ja' ? 'en' : 'ja';
  document.getElementById('langSwitcher').textContent = currentLang === 'ja' ? 'EN' : 'JA';
  renderTodos();
  renderMemos();
  updateMemoTags();
});

document.getElementById('searchInput').addEventListener('input', function() {
  const query = this.value.toLowerCase().trim();
  const resultsDiv = document.getElementById('searchResults');
  const t = translations[currentLang];
  if (!query) { resultsDiv.innerHTML = ''; return; }

  const results = [];
  todos.forEach(todo => {
    if (todo.text.toLowerCase().includes(query) || (todo.tags && todo.tags.some(tag => tag.toLowerCase().includes(query))) || (todo.note && todo.note.toLowerCase().includes(query))) {
      results.push({ type: 'todo', id: todo.id, title: todo.text, preview: todo.completed ? 'âœ“ ' + t.completed : t.active });
    }
  });
  memos.forEach(memo => {
    if (memo.title.toLowerCase().includes(query) || memo.content.toLowerCase().includes(query) || (memo.tags && memo.tags.some(tag => tag.toLowerCase().includes(query)))) {
      results.push({ type: 'memo', id: memo.id, title: memo.title, preview: memo.content.substring(0, 100) + '...' });
    }
  });

  if (results.length === 0) {
    resultsDiv.innerHTML = `<p style="color:#9ca3af;text-align:center">${currentLang === 'ja' ? 'æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' : 'No results found'}</p>`;
    return;
  }
  resultsDiv.innerHTML = results.map(r => `
    <div class="search-result-item" onclick="jumpTo('${r.type}', ${r.id})">
      <div class="search-result-title">${r.type === 'todo' ? 'ğŸ“' : 'ğŸ“„'} ${r.title}</div>
      <div class="search-result-preview">${r.preview}</div>
    </div>`).join('');
});

document.addEventListener('keydown', e => {
  if (document.activeElement.id === 'memoContent') {
    if ((e.ctrlKey || e.metaKey) && e.key === 'b') { e.preventDefault(); insertText('**å¤ªå­—**'); return; }
    if ((e.ctrlKey || e.metaKey) && e.key === 'i') { e.preventDefault(); insertText('*æ–œä½“*'); return; }
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); insertLink(); return; }
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'K') { e.preventDefault(); insertText('```\n\n```'); return; }
  }
  if ((e.ctrlKey || e.metaKey) && e.key === 'k' && document.activeElement.id !== 'memoContent') {
    e.preventDefault(); openSearch(); return;
  }
  if (e.key === 'Escape') {
    closeSearch(); closeEditTodoModal(); closeStats(); closeSettings(); closeKeyboardShortcuts();
    document.getElementById('shortcutsModal').classList.remove('active');
  }
});

// â”€â”€â”€ åˆæœŸåŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadData();
</script>
</body>
</html>