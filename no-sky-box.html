<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reflective Sphere</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #000; overflow: hidden; width: 100vw; height: 100vh; font-family: sans-serif; }
  canvas { display: block; }

  #upload-ui {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #000;
    z-index: 10;
    transition: opacity 0.6s ease;
  }
  #upload-ui.hidden {
    opacity: 0;
    pointer-events: none;
  }

  #drop-zone {
    width: 340px;
    height: 220px;
    border: 2px dashed rgba(255,255,255,0.3);
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    color: rgba(255,255,255,0.7);
  }
  #drop-zone:hover, #drop-zone.dragover {
    border-color: rgba(255,255,255,0.8);
    background: rgba(255,255,255,0.05);
  }
  #drop-zone svg { opacity: 0.5; }
  #drop-zone p { font-size: 14px; text-align: center; line-height: 1.6; }
  #drop-zone span { font-size: 12px; opacity: 0.5; }

  #file-input { display: none; }

  #hint {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    color: rgba(255,255,255,0.35);
    font-size: 12px;
    letter-spacing: 0.05em;
    pointer-events: none;
    z-index: 5;
    transition: opacity 0.4s;
  }

  #change-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 5;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    cursor: pointer;
    backdrop-filter: blur(10px);
    transition: background 0.2s;
    display: none;
  }
  #change-btn:hover { background: rgba(255,255,255,0.2); }

  #credit {
    position: fixed;
    bottom: 12px;
    right: 16px;
    color: rgba(255,255,255,0.25);
    font-size: 11px;
    letter-spacing: 0.04em;
    pointer-events: none;
    z-index: 5;
  }
</style>
</head>
<body>

<!-- Upload UI -->
<div id="upload-ui">
  <div id="drop-zone" onclick="document.getElementById('file-input').click()">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
      <polyline points="17 8 12 3 7 8"/>
      <line x1="12" y1="3" x2="12" y2="15"/>
    </svg>
    <p>ÁîªÂÉè„Çí„Éâ„É≠„ÉÉ„Éó<br>„Åæ„Åü„ÅØ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏Êäû</p>
    <span>JPG / PNG / WEBP ÂØæÂøú</span>
  </div>
  <input type="file" id="file-input" accept="image/*">
</div>

<div id="hint">„Éâ„É©„ÉÉ„Ç∞„ÅßËá™Áî±„Å´ÂõûËª¢„Åß„Åç„Åæ„Åô</div>
<button id="change-btn" onclick="resetUI()">üñº ÁîªÂÉè„ÇíÂ§âÊõ¥</button>
<div id="credit">based on greggman's skybox</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// ============================================================
//  üñº  „Éá„Éï„Ç©„É´„ÉàÁîªÂÉè„ÅÆË®≠ÂÆö
//  Âêå„Åò„Éï„Ç©„É´„ÉÄ„Å´ÁîªÂÉè„ÇíÁΩÆ„ÅÑ„Å¶„Éë„Çπ„ÇíÊåáÂÆö„Åô„Çã„Å®Ëµ∑ÂãïÊôÇ„Å´Ëá™Âãï„ÅßË™≠„ÅøËæº„Åæ„Çå„Åæ„Åô
//  ‰æã: 'images/default.jpg'  /  'photo.png'  /  '' (Á©∫Ê¨Ñ = ‰ΩøÁî®„Åó„Å™„ÅÑ)
// ============================================================
const DEFAULT_IMAGE = 'images/default.png';
// ============================================================

// --- Three.js Setup ---
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.set(0, 0, 3);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
renderer.outputEncoding = THREE.sRGBEncoding;
document.body.appendChild(renderer.domElement);

let sphere = null;
let currentTex = null;
let animating = false;

// Orbit state
let isDragging = false;
let prevMouse = { x: 0, y: 0 };
let spherical = { theta: 0, phi: Math.PI / 2 }; // azimuth, polar
let targetSpherical = { theta: 0, phi: Math.PI / 2 };
const RADIUS = 3;
let velocity = { theta: 0, phi: 0 };

function loadImageTexture(src) {
  const img = new Image();
  img.onload = () => {
    if (currentTex) currentTex.dispose();

    const tex = new THREE.Texture(img);
    tex.mapping = THREE.EquirectangularReflectionMapping;
    tex.encoding = THREE.sRGBEncoding;
    tex.needsUpdate = true;
    currentTex = tex;

    scene.background = tex;
    scene.environment = tex;

    if (!sphere) {
      const geo = new THREE.SphereGeometry(1, 128, 128);
      const mat = new THREE.MeshStandardMaterial({
        envMap: tex,
        envMapIntensity: 1.0,
        metalness: 1.0,
        roughness: 0.0,
      });
      sphere = new THREE.Mesh(geo, mat);
      scene.add(sphere);
    } else {
      sphere.material.envMap = tex;
      sphere.material.needsUpdate = true;
    }

    // Show scene
    document.getElementById('upload-ui').classList.add('hidden');
    document.getElementById('change-btn').style.display = 'block';

    if (!animating) {
      animating = true;
      animate();
    }
  };
  img.src = src;
}

function animate() {
  requestAnimationFrame(animate);

  // Inertia / smooth follow
  if (!isDragging) {
    velocity.theta *= 0.92;
    velocity.phi *= 0.92;
    targetSpherical.theta += velocity.theta;
    targetSpherical.phi += velocity.phi;
  }

  // Clamp polar angle
  targetSpherical.phi = Math.max(0.15, Math.min(Math.PI - 0.15, targetSpherical.phi));

  spherical.theta += (targetSpherical.theta - spherical.theta) * 0.1;
  spherical.phi   += (targetSpherical.phi   - spherical.phi)   * 0.1;

  camera.position.x = RADIUS * Math.sin(spherical.phi) * Math.sin(spherical.theta);
  camera.position.y = RADIUS * Math.cos(spherical.phi);
  camera.position.z = RADIUS * Math.sin(spherical.phi) * Math.cos(spherical.theta);
  camera.lookAt(0, 0, 0);

  if (currentTex && !isDragging && Math.abs(velocity.theta) < 0.0001) {
    currentTex.offset.x += 0.0001;
  }

  renderer.render(scene, camera);
}

function resetUI() {
  document.getElementById('upload-ui').style.opacity = '';
  document.getElementById('upload-ui').classList.remove('hidden');
  document.getElementById('upload-ui').style.transition = 'opacity 0.4s';
  document.getElementById('change-btn').style.display = 'none';
  document.getElementById('file-input').value = '';
}

// --- File input ---
document.getElementById('file-input').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => loadImageTexture(ev.target.result);
  reader.readAsDataURL(file);
});

// --- Drag & Drop ---
const dropZone = document.getElementById('drop-zone');

dropZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropZone.classList.add('dragover');
});
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (!file || !file.type.startsWith('image/')) return;
  const reader = new FileReader();
  reader.onload = (ev) => loadImageTexture(ev.target.result);
  reader.readAsDataURL(file);
});

// Also allow dropping anywhere on the page when sphere is showing
document.addEventListener('dragover', (e) => e.preventDefault());
document.addEventListener('drop', (e) => {
  e.preventDefault();
  const file = e.dataTransfer.files[0];
  if (!file || !file.type.startsWith('image/')) return;
  const reader = new FileReader();
  reader.onload = (ev) => loadImageTexture(ev.target.result);
  reader.readAsDataURL(file);
});

// --- Mouse drag orbit ---
const canvas = renderer.domElement;

canvas.addEventListener('mousedown', (e) => {
  isDragging = true;
  prevMouse = { x: e.clientX, y: e.clientY };
  velocity = { theta: 0, phi: 0 };
  canvas.style.cursor = 'grabbing';
});

document.addEventListener('mousemove', (e) => {
  if (!isDragging) return;
  const dx = e.clientX - prevMouse.x;
  const dy = e.clientY - prevMouse.y;
  velocity.theta = -dx * 0.005;
  velocity.phi   = -dy * 0.005;
  targetSpherical.theta += velocity.theta;
  targetSpherical.phi   += velocity.phi;
  prevMouse = { x: e.clientX, y: e.clientY };
});

document.addEventListener('mouseup', () => {
  isDragging = false;
  canvas.style.cursor = 'grab';
});

canvas.style.cursor = 'grab';

// --- Touch drag orbit ---
let prevTouch = null;

canvas.addEventListener('touchstart', (e) => {
  if (e.touches.length === 1) {
    isDragging = true;
    prevTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
    velocity = { theta: 0, phi: 0 };
  }
}, { passive: true });

canvas.addEventListener('touchmove', (e) => {
  if (!isDragging || e.touches.length !== 1) return;
  e.preventDefault();
  const dx = e.touches[0].clientX - prevTouch.x;
  const dy = e.touches[0].clientY - prevTouch.y;
  velocity.theta = -dx * 0.005;
  velocity.phi   = -dy * 0.005;
  targetSpherical.theta += velocity.theta;
  targetSpherical.phi   += velocity.phi;
  prevTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
}, { passive: false });

canvas.addEventListener('touchend', () => {
  isDragging = false;
  prevTouch = null;
});

// --- Resize ---
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

// --- Default image auto-load ---
if (DEFAULT_IMAGE) {
  loadImageTexture(DEFAULT_IMAGE);
}
</script>
</body>
</html>