<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="images/icon.png" type="image/png">
<title>Reflective Sphere</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { background:#000; overflow:hidden; width:100vw; height:100vh; font-family:sans-serif; }
canvas.gl { display:block; }
#ui {
  position:fixed; inset:0; display:flex; flex-direction:column;
  align-items:center; justify-content:center; background:#000; z-index:10;
  transition:opacity .5s;
}
#ui.gone { opacity:0; pointer-events:none; }
#drop {
  width:340px; height:220px; border:2px dashed rgba(255,255,255,.3); border-radius:16px;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:12px; cursor:pointer; color:rgba(255,255,255,.7);
  transition:border-color .2s, background .2s;
}
#drop:hover, #drop.over { border-color:rgba(255,255,255,.8); background:rgba(255,255,255,.05); }
#drop svg { opacity:.5; }
#drop p { font-size:14px; text-align:center; line-height:1.6; }
#drop small { font-size:11px; opacity:.4; }
input[type=file] { display:none; }
#hint {
  position:fixed; bottom:40px; left:50%; transform:translateX(-50%);
  color:rgba(255,255,255,.3); font-size:12px; pointer-events:none; z-index:5; white-space:nowrap;
}
#chg {
  position:fixed; top:16px; right:16px; z-index:5;
  background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.2);
  color:#fff; padding:7px 14px; border-radius:20px; font-size:12px;
  cursor:pointer; display:none; backdrop-filter:blur(8px);
}
#chg:hover { background:rgba(255,255,255,.2); }
#badge {
  position:fixed; top:16px; left:16px; z-index:5;
  background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.2);
  color:rgba(255,255,255,.7); padding:4px 12px; border-radius:20px;
  font-size:11px; display:none; backdrop-filter:blur(8px);
}
#loading {
  position:fixed; inset:0; background:rgba(0,0,0,.85);
  display:none; align-items:center; justify-content:center;
  color:#fff; font-size:14px; z-index:20; flex-direction:column; gap:12px;
}
#loading.show { display:flex; }
#nav {
  position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
  display:none; gap:10px; z-index:5; align-items:center;
}
.nbtn {
  background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.2);
  color:#fff; width:34px; height:34px; border-radius:50%; font-size:18px;
  cursor:pointer; backdrop-filter:blur(8px); display:flex; align-items:center; justify-content:center;
}
.nbtn:hover { background:rgba(255,255,255,.25); }
#ncnt { color:rgba(255,255,255,.5); font-size:11px; min-width:44px; text-align:center; }
#tapbtn {
  padding:10px 26px; border-radius:20px;
  background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.4);
  color:#fff; font-size:14px; cursor:pointer; display:none;
}
#tapbtn.show { display:block; }
#credit {
  position:fixed; bottom:16px; right:16px; z-index:5;
  color:rgba(255,255,255,.35); font-size:11px; pointer-events:none;
  font-family:sans-serif;
}
#credit a {
  color:rgba(255,255,255,.5); text-decoration:none; pointer-events:auto;
}
#credit a:hover { color:rgba(255,255,255,.9); }
</style>
</head>
<body>

<div id="ui">
  <div id="drop" onclick="document.getElementById('fi').click()">
    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
      <polyline points="17 8 12 3 7 8"/>
      <line x1="12" y1="3" x2="12" y2="15"/>
    </svg>
    <p>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ­ãƒƒãƒ—</p>
    <small>JPG / PNG / WEBP / GIF / MP4 / WebM</small>
  </div>
  <input type="file" id="fi" accept="image/*,video/*">
</div>

<div id="nav">
  <button class="nbtn" onclick="navGo(-1)">&#8249;</button>
  <span id="ncnt"></span>
  <button class="nbtn" onclick="navGo(1)">&#8250;</button>
</div>
<div id="loading">
  <span id="ltxt">èª­ã¿è¾¼ã¿ä¸­â€¦</span>
  <button id="tapbtn" onclick="doPlay()">â–¶ ã‚¿ãƒƒãƒ—ã—ã¦å†ç”Ÿ</button>
</div>
<div id="hint">ãƒ‰ãƒ©ãƒƒã‚°ã§çƒã‚’å›è»¢</div>
<button id="chg" onclick="reset()">ğŸ–¼ å¤‰æ›´</button>
<div id="badge"></div>

<div id="credit">Based by <a href="https://greggman.github.io/doodles/" target="_blank">Greggman (no sky box)</a></div>

<video id="vid" muted loop playsinline
  style="position:fixed;width:1px;height:1px;opacity:.01;top:0;left:0;pointer-events:none"></video>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// â”€â”€ GIF LZWãƒ‡ã‚³ãƒ¼ãƒ€ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lzwDecode(minCode, bytes) {
  var cc=1<<minCode, eoi=cc+1, tSize=cc+2;
  var table=[];
  for(var i=0;i<cc;i++) table[i]=[i];
  table[cc]=[]; table[eoi]=[];
  var out=[], bits=0, buf=0, bp=0, cs=minCode+1, mask=(1<<cs)-1, prev=null;
  function next() {
    while(bits<cs){ buf|=(bp<bytes.length?bytes[bp]:0)<<bits; bp++; bits+=8; }
    var c=buf&mask; buf>>>=cs; bits-=cs; return c;
  }
  for(;;){
    var code=next();
    if(code===eoi) break;
    if(code===cc){ tSize=cc+2; cs=minCode+1; mask=(1<<cs)-1; table=table.slice(0,tSize); prev=null; continue; }
    var e;
    if(code<tSize)       e=table[code];
    else if(prev!==null) e=prev.concat([prev[0]]);
    else break;
    for(var k=0;k<e.length;k++) out.push(e[k]);
    if(prev!==null){
      table[tSize]=prev.concat([e[0]]); tSize++;
      if(tSize===(1<<cs)&&cs<12){ cs++; mask=(1<<cs)-1; }
    }
    prev=e;
  }
  return new Uint8Array(out);
}

function decodeGif(buf) {
  var d=new Uint8Array(buf), p=0;
  function u8()  { return d[p++]; }
  function u16() { var v=d[p]|(d[p+1]<<8); p+=2; return v; }
  function readCT(n){ var a=new Uint8Array(n*3); for(var i=0;i<n*3;i++) a[i]=d[p++]; return a; }
  function skipBlocks(){ var s; while((s=u8())>0) p+=s; }
  function readBlocks(){
    var out=[],s; while((s=u8())>0){for(var i=0;i<s;i++) out.push(d[p++]);} return new Uint8Array(out);
  }
  function deinterlace(pix,w,h){
    var o=new Uint8Array(pix.length),rows=[],i;
    for(i=0;i<h;i+=8)rows.push(i); for(i=4;i<h;i+=8)rows.push(i);
    for(i=2;i<h;i+=4)rows.push(i); for(i=1;i<h;i+=2)rows.push(i);
    for(i=0;i<rows.length;i++){var s=rows[i]*w,t=i*w;for(var j=0;j<w;j++)o[t+j]=pix[s+j];}
    return o;
  }

  p+=6;
  var sw=u16(),sh=u16(),pk=u8(); u8(); u8();
  var gflag=(pk>>7)&1, gsz=pk&7;
  var gct=gflag?readCT(1<<(gsz+1)):null;
  var frames=[];
  var gce={delay:100,ti:-1,dis:0};
  var comp=document.createElement('canvas'); comp.width=sw; comp.height=sh;
  var cctx=comp.getContext('2d');

  while(p<d.length){
    var s=u8();
    if(s===0x3B) break;
    if(s===0x21){
      var lb=u8();
      if(lb===0xF9){
        u8(); var gp=u8();
        gce.dis=(gp>>3)&7;
        var ht=gp&1;
        gce.delay=u16()*10||100;
        if(ht){ gce.ti=u8(); } else { u8(); gce.ti=-1; }
        u8();
      } else { skipBlocks(); }
    } else if(s===0x2C){
      var fx=u16(),fy=u16(),fw=u16(),fh=u16(),ip=u8();
      var lf=(ip>>7)&1, ls=ip&7, il=(ip>>6)&1;
      var lct=lf?readCT(1<<(ls+1)):null;
      var pal=lct||gct;
      var mc=u8(), raw=readBlocks();
      var pix=lzwDecode(mc,raw);
      if(il) pix=deinterlace(pix,fw,fh);

      var prevData=null;
      if(gce.dis===3) prevData=cctx.getImageData(0,0,sw,sh);
      if(gce.dis===2) cctx.clearRect(fx,fy,fw,fh);

      var id=cctx.createImageData(fw,fh); var dd=id.data;
      for(var i=0;i<pix.length&&i<fw*fh;i++){
        var ci=pix[i];
        if(ci===gce.ti) continue;
        var ri=ci*3, bi=i*4;
        dd[bi]=pal[ri]; dd[bi+1]=pal[ri+1]; dd[bi+2]=pal[ri+2]; dd[bi+3]=255;
      }
      cctx.putImageData(id,fx,fy);
      frames.push({ imageData: cctx.getImageData(0,0,sw,sh), delay: gce.delay });

      if(gce.dis===3&&prevData) cctx.putImageData(prevData,0,0);
      gce={delay:100,ti:-1,dis:0};
    }
  }
  return { w:sw, h:sh, frames:frames };
}

// â”€â”€ GIF ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚¿ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var gifFrames=[], gifIdx=0, gifTimer=null;
function stopGif(){ if(gifTimer){clearTimeout(gifTimer);gifTimer=null;} gifFrames=[]; gifIdx=0; }
function startGif(){
  function step(){
    if(!gifFrames.length||mode!=='gif') return;
    var f=gifFrames[gifIdx];
    oct.putImageData(f.imageData,0,0);
    dirty();
    gifIdx=(gifIdx+1)%gifFrames.length;
    gifTimer=setTimeout(step, gifFrames[gifIdx].delay||100);
  }
  step();
}

// â”€â”€ ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ï¼ˆå…ƒã®ã¾ã¾ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var VS_SKY=`
varying vec3 vDir;
void main(){
  vDir=position;
  gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);
}`;
var FS_SKY=`
uniform sampler2D uTex;
uniform mat3 uRot;
varying vec3 vDir;
const float PI=3.141592653589793;
void main(){
  vec3 d=normalize(uRot*vDir);
  float u=0.5+atan(d.z,d.x)/(2.0*PI);
  float v=0.5+asin(clamp(d.y,-1.0,1.0))/PI;
  gl_FragColor=texture2D(uTex,vec2(u,v));
}`;
var VS_BALL=`
varying vec3 vNormal;
varying vec3 vViewDir;
void main(){
  vec4 wp=modelMatrix*vec4(position,1.0);
  vNormal=normalize(mat3(modelMatrix)*normal);
  vViewDir=normalize(wp.xyz-cameraPosition);
  gl_Position=projectionMatrix*viewMatrix*wp;
}`;
var FS_BALL=`
uniform sampler2D uTex;
uniform mat3 uRot;
varying vec3 vNormal;
varying vec3 vViewDir;
const float PI=3.141592653589793;
void main(){
  vec3 R=reflect(vViewDir,normalize(vNormal));
  R=uRot*R;
  float u=0.5+atan(R.z,R.x)/(2.0*PI);
  float v=0.5+asin(clamp(R.y,-1.0,1.0))/PI;
  gl_FragColor=texture2D(uTex,vec2(u,v));
}`;

// â”€â”€ Three.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var scene=new THREE.Scene();
var camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,200);
camera.position.set(0,0,4); camera.lookAt(0,0,0);
var renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.domElement.className='gl';
document.body.appendChild(renderer.domElement);

var skyU ={uTex:{value:null},uRot:{value:new THREE.Matrix3()}};
var ballU={uTex:{value:null},uRot:{value:new THREE.Matrix3()}};
scene.add(new THREE.Mesh(
  new THREE.SphereGeometry(50,64,32),
  new THREE.ShaderMaterial({uniforms:skyU,vertexShader:VS_SKY,fragmentShader:FS_SKY,side:THREE.BackSide,depthWrite:false})
));
var ball=new THREE.Mesh(
  new THREE.SphereGeometry(1.25,128,64),
  new THREE.ShaderMaterial({uniforms:ballU,vertexShader:VS_BALL,fragmentShader:FS_BALL})
);
scene.add(ball);

// â”€â”€ Canvas ãƒ†ã‚¯ã‚¹ãƒãƒ£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var oc=document.createElement('canvas');
var oct=oc.getContext('2d');
var dynTex=null, staticTex=null;
function setTex(t){ skyU.uTex.value=t; ballU.uTex.value=t; }
function initCanvasTex(w,h){
  oc.width=w; oc.height=h;
  if(dynTex) dynTex.dispose();
  dynTex=new THREE.CanvasTexture(oc);
  dynTex.minFilter=THREE.LinearFilter;
  dynTex.magFilter=THREE.LinearFilter;
  setTex(dynTex);
}
function dirty(){ if(dynTex) dynTex.needsUpdate=true; }

// â”€â”€ å‹•ç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’Canvasã«å·¦å³åè»¢ã—ã¦æç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawVideoFlipped(){
  try{
    oct.save();
    oct.translate(oc.width, 0);
    oct.scale(-1, 1);
    oct.drawImage(vid, 0, 0, oc.width, oc.height);
    oct.restore();
  }catch(e){}
  dirty();
}

// â”€â”€ çŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var mode='';
var vid=document.getElementById('vid');
var pollT=null;
var dragging=false, px=0, py=0, vx=0, vy=0;
var quat=new THREE.Quaternion();
var running=false;

// â”€â”€ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var playlist=[], plIdx=0;

function navGo(dir){
  if(playlist.length<2) return;
  plIdx=(plIdx+dir+playlist.length)%playlist.length;
  playItem(playlist[plIdx]);
}
function updateNav(){
  var nav=document.getElementById('nav');
  if(playlist.length>1){
    nav.style.display='flex';
    document.getElementById('ncnt').textContent=(plIdx+1)+' / '+playlist.length;
  } else {
    nav.style.display='none';
  }
}
function playItem(item){
  if(item.type==='gif')        loadGifBuf(item.buf);
  else if(item.type==='video') loadVid(item.url);
  else                         loadImg(item.url);
}

// â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLoad(v,t){ document.getElementById('loading').classList.toggle('show',v); if(t) document.getElementById('ltxt').textContent=t; }
function showTap(v){ document.getElementById('tapbtn').classList.toggle('show',v); }
function setBadge(t){ var b=document.getElementById('badge'); b.style.display=t?'block':'none'; b.textContent=t; }
function showScene(){
  showLoad(false); showTap(false);
  document.getElementById('ui').classList.add('gone');
  document.getElementById('chg').style.display='block';
  updateNav();
  if(!running){ running=true; loop(); }
}
function doPlay(){
  showTap(false);
  vid.play().then(showScene).catch(function(){ document.getElementById('ltxt').textContent='å†ç”Ÿã§ãã¾ã›ã‚“ã§ã—ãŸ'; });
}
function reset(){
  mode=''; stopGif();
  vid.pause(); vid.removeAttribute('src'); try{vid.load();}catch(e){}
  if(pollT){clearInterval(pollT);pollT=null;}
  document.getElementById('ui').classList.remove('gone');
  document.getElementById('chg').style.display='none';
  document.getElementById('nav').style.display='none';
  setBadge('');
  document.getElementById('fi').value='';
}

// â”€â”€ ãƒ­ãƒ¼ãƒ€ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadImg(src){
  showLoad(true,'èª­ã¿è¾¼ã¿ä¸­â€¦');
  var img=new Image();
  img.onload=function(){
    if(staticTex) staticTex.dispose();
    staticTex=new THREE.Texture(img);
    staticTex.minFilter=THREE.LinearFilter;
    staticTex.magFilter=THREE.LinearFilter;
    staticTex.needsUpdate=true;
    setTex(staticTex); mode='image'; setBadge(''); showScene();
  };
  img.onerror=function(){ showLoad(false); alert('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); };
  img.src=src;
}

function loadGifBuf(buf){
  showLoad(true,'GIFè§£æä¸­â€¦');
  stopGif();
  setTimeout(function(){
    try{
      var gif=decodeGif(buf);
      if(!gif.frames.length){ showLoad(false); alert('GIFãƒ•ãƒ¬ãƒ¼ãƒ ãªã—'); return; }
      initCanvasTex(gif.w,gif.h);
      gifFrames=gif.frames; gifIdx=0;
      mode='gif'; setBadge('âŸ³ GIF');
      showScene();
      startGif();
    }catch(e){ showLoad(false); alert('GIFè§£æã‚¨ãƒ©ãƒ¼: '+e.message); }
  },0);
}

function loadVid(src){
  showLoad(true,'èª­ã¿è¾¼ã¿ä¸­â€¦');
  vid.src=src; vid.load();
  var ok=false;
  function go(){
    if(ok||vid.readyState<1||!vid.videoWidth) return;
    ok=true;
    if(pollT){clearInterval(pollT);pollT=null;}
    initCanvasTex(vid.videoWidth,vid.videoHeight);
    drawVideoFlipped();
    mode='video'; setBadge('â–¶ VIDEO');
    var pr=vid.play();
    if(pr) pr.then(showScene).catch(function(){ showScene(); showLoad(true,'ã‚¿ãƒƒãƒ—ã—ã¦å†ç”Ÿ'); showTap(true); });
    else showScene();
  }
  var el=0;
  pollT=setInterval(function(){ el+=100; go(); if(el>10000&&!ok){clearInterval(pollT);pollT=null;showLoad(false);alert('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');} },100);
  vid.addEventListener('loadedmetadata',go,{once:true});
  vid.addEventListener('canplay',go,{once:true});
  vid.addEventListener('error',function(){ if(pollT){clearInterval(pollT);pollT=null;} showLoad(false); alert('å‹•ç”»ã‚¨ãƒ©ãƒ¼'); },{once:true});
}

// â”€â”€ ã‚¢ãƒ‹ãƒ¡ãƒ«ãƒ¼ãƒ— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyRot(dx,dy){
  var sp=0.005;
  var qy=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),dx*sp);
  var qx=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),dy*sp);
  quat.premultiply(qy).premultiply(qx);
}
function loop(){
  requestAnimationFrame(loop);
  if(!dragging&&(Math.abs(vx)>0.001||Math.abs(vy)>0.001)){
    applyRot(vx,vy); vx*=0.90; vy*=0.90;
  }
  var inv=quat.clone().invert();
  var m3=new THREE.Matrix3().setFromMatrix4(new THREE.Matrix4().makeRotationFromQuaternion(inv));
  ballU.uRot.value=m3;
  var eu=new THREE.Euler().setFromQuaternion(inv,'YXZ');
  skyU.uRot.value=new THREE.Matrix3().setFromMatrix4(new THREE.Matrix4().makeRotationY(-eu.y));
  if(mode==='video'&&vid.readyState>=2){
    drawVideoFlipped(); // â† å‹•ç”»ã¯å·¦å³åè»¢ã—ã¦æç”»
  }
  renderer.render(scene,camera);
}

// â”€â”€ ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleFile(file){
  if(!file) return;
  if(file.type==='image/gif'){
    var r=new FileReader();
    r.onload=function(e){
      var item={type:'gif',buf:e.target.result,name:file.name};
      playlist.push(item); plIdx=playlist.length-1;
      loadGifBuf(e.target.result);
    };
    r.readAsArrayBuffer(file);
  } else if(file.type.startsWith('video/')){
    var url=URL.createObjectURL(file);
    playlist.push({type:'video',url:url,name:file.name});
    plIdx=playlist.length-1;
    loadVid(url);
  } else {
    var r2=new FileReader();
    r2.onload=function(e){
      playlist.push({type:'image',url:e.target.result,name:file.name});
      plIdx=playlist.length-1;
      loadImg(e.target.result);
    };
    r2.readAsDataURL(file);
  }
}
document.getElementById('fi').onchange=function(e){
  Array.prototype.slice.call(e.target.files).forEach(handleFile);
};
var dz=document.getElementById('drop');
dz.addEventListener('dragover',function(e){e.preventDefault();dz.classList.add('over');});
dz.addEventListener('dragleave',function(){dz.classList.remove('over');});
dz.addEventListener('drop',function(e){
  e.preventDefault(); dz.classList.remove('over');
  Array.prototype.slice.call(e.dataTransfer.files).forEach(handleFile);
});
document.addEventListener('dragover',function(e){e.preventDefault();});
document.addEventListener('drop',function(e){
  e.preventDefault();
  Array.prototype.slice.call(e.dataTransfer.files).forEach(handleFile);
});

// â”€â”€ ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var gc=renderer.domElement;
gc.addEventListener('mousedown',function(e){dragging=true;px=e.clientX;py=e.clientY;vx=0;vy=0;gc.style.cursor='grabbing';});
document.addEventListener('mousemove',function(e){
  if(!dragging)return;
  var dx=e.clientX-px,dy=e.clientY-py;
  vx=dx;vy=dy;applyRot(dx,dy);px=e.clientX;py=e.clientY;
});
document.addEventListener('mouseup',function(){dragging=false;gc.style.cursor='grab';});
gc.style.cursor='grab';
gc.addEventListener('touchstart',function(e){if(e.touches.length===1){dragging=true;px=e.touches[0].clientX;py=e.touches[0].clientY;vx=0;vy=0;}},{passive:true});
gc.addEventListener('touchmove',function(e){
  if(!dragging||e.touches.length!==1)return;e.preventDefault();
  var dx=e.touches[0].clientX-px,dy=e.touches[0].clientY-py;
  vx=dx;vy=dy;applyRot(dx,dy);px=e.touches[0].clientX;py=e.touches[0].clientY;
},{passive:false});
gc.addEventListener('touchend',function(){dragging=false;});
window.addEventListener('resize',function(){
  camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

function addDefault(type, url){
  playlist.push({type:type, url:url, name:url});
  if(playlist.length===1){ plIdx=0; playItem(playlist[0]); }
}
function addDefaultGif(url){
  fetch(url)
    .then(function(r){ return r.arrayBuffer(); })
    .then(function(buf){
      playlist.push({type:'gif', buf:buf, name:url});
      if(playlist.length===1){ plIdx=0; loadGifBuf(buf); }
    })
    .catch(function(e){ console.warn('GIF load failed:', url, e); });
}

// â†“ ã“ã“ã‚’ç·¨é›†ã—ã¦ãã ã•ã„
addDefault('image', 'images/default1.png');
addDefault('video', 'images/default2.mp4');
addDefaultGif('images/default3.gif');
addDefault('image', 'images/default4.png')
</script>
</body>
</html>
